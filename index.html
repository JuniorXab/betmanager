<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#0a6b2e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="BlackJack">
<meta name="mobile-web-app-capable" content="yes">
<meta name="description" content="BlackJack multijugador en tiempo real">
<link rel="manifest" id="pwaManifest">
<link rel="apple-touch-icon" id="appleIcon">
<title>BlackJack Royale ğŸƒ</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
:root{
  --gold:#c9a84c;--gold-l:#f5d976;--gold-d:#7a5510;--glow:rgba(201,168,76,.4);
  --bg:#04080f;--bg2:#080e18;--bg3:#0e1520;--bg4:#141c2a;
  --felt:#0a5c28;--felt2:#0d7032;
  --red:#c0392b;--red2:#e74c3c;
  --text:#f0e8d4;--dim:#4a5a40;--border:#1a2030;
  --green:#2ecc71;--blue:#3498db;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;}
html,body{height:100%;overflow:hidden;}
body{font-family:'Georgia',serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;height:100dvh;}

/* â”€â”€ PARTICLES â”€â”€ */
#pt{position:fixed;inset:0;pointer-events:none;z-index:9000;overflow:hidden;}
.p{position:absolute;border-radius:50%;animation:pf linear forwards;}
@keyframes pf{0%{opacity:1;transform:translateY(0)rotate(0);}100%{opacity:0;transform:translateY(110vh)rotate(900deg);}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREENS SYSTEM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fullscreen{
  position:fixed;inset:0;z-index:500;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:20px;
}
.fullscreen.hidden{display:none!important;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WELCOME SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#scWelcome{background:radial-gradient(ellipse at 50% 30%,#0c1a28,#04080f);}
.wl-suits{font-size:32px;letter-spacing:8px;margin-bottom:12px;opacity:.6;}
.wl-title{font-size:36px;font-weight:900;color:#fff;letter-spacing:3px;margin-bottom:4px;text-align:center;}
.wl-sub{font-size:12px;color:var(--dim);letter-spacing:2px;margin-bottom:28px;text-align:center;text-transform:uppercase;}
.glass-card{
  background:linear-gradient(160deg,rgba(255,255,255,.04),rgba(255,255,255,.01));
  border:1px solid rgba(255,255,255,.08);border-radius:20px;
  padding:24px;width:100%;max-width:340px;
  box-shadow:0 20px 60px rgba(0,0,0,.6);
  backdrop-filter:blur(10px);
}
.field-lbl{font-size:10px;letter-spacing:3px;color:var(--dim);text-transform:uppercase;margin-bottom:7px;}
.field{
  width:100%;background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.1);border-radius:12px;
  padding:14px 16px;font-size:16px;color:var(--text);font-family:inherit;
  outline:none;transition:border-color .2s,box-shadow .2s;margin-bottom:16px;
}
.field:focus{border-color:rgba(201,168,76,.5);box-shadow:0 0 0 3px rgba(201,168,76,.1);}
.field::placeholder{color:rgba(255,255,255,.2);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOBBY SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#scLobby{background:radial-gradient(ellipse at 50% 30%,#0c1a28,#04080f);}
.lobby-card{background:linear-gradient(160deg,rgba(255,255,255,.04),rgba(255,255,255,.01));border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:20px;width:100%;max-width:360px;box-shadow:0 20px 60px rgba(0,0,0,.6);}
.lobby-header{display:flex;align-items:center;gap:10px;margin-bottom:20px;}
.lb-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:bold;color:#000;flex-shrink:0;}
.lb-player-name{font-size:15px;font-weight:bold;}
.lb-player-bal{font-size:11px;color:var(--gold);}

.or-divider{display:flex;align-items:center;gap:10px;margin:12px 0;}
.or-divider::before,.or-divider::after{content:'';flex:1;height:1px;background:rgba(255,255,255,.07);}
.or-divider span{font-size:10px;color:var(--dim);letter-spacing:2px;}

.join-row{display:flex;gap:8px;}
.join-row .field{margin-bottom:0;flex:1;font-size:14px;text-transform:uppercase;letter-spacing:3px;}

/* Firebase setup link */
.firebase-note{
  background:rgba(255,152,0,.06);border:1px solid rgba(255,152,0,.2);
  border-radius:10px;padding:10px 12px;font-size:10px;color:#f39c12;
  line-height:1.6;margin-top:12px;text-align:center;cursor:pointer;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROOM WAITING SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#scWaiting{background:radial-gradient(ellipse at 50% 20%,#0c1a28,#04080f);}
.room-code-display{
  text-align:center;margin-bottom:24px;
}
.room-code-lbl{font-size:10px;letter-spacing:3px;color:var(--dim);text-transform:uppercase;margin-bottom:8px;}
.room-code{
  font-size:44px;font-weight:900;letter-spacing:10px;color:var(--gold);
  text-shadow:0 0 30px var(--glow);
}
.room-code-sub{font-size:11px;color:var(--dim);margin-top:6px;}
.waiting-card{background:linear-gradient(160deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(255,255,255,.07);border-radius:18px;padding:18px;width:100%;max-width:360px;}
.waiting-title{font-size:11px;letter-spacing:3px;color:var(--dim);text-transform:uppercase;margin-bottom:12px;}
.player-list{display:flex;flex-direction:column;gap:8px;margin-bottom:16px;min-height:80px;}
.player-slot{
  display:flex;align-items:center;gap:10px;
  padding:10px 12px;border-radius:12px;
  background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);
  animation:slideIn .3s ease;
}
@keyframes slideIn{from{opacity:0;transform:translateX(-10px);}to{opacity:1;transform:none;}}
.ps-avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:bold;color:#000;flex-shrink:0;}
.ps-name{font-size:13px;font-weight:bold;flex:1;}
.ps-badge{font-size:10px;padding:2px 8px;border-radius:10px;font-weight:bold;}
.ps-badge.host{background:rgba(201,168,76,.2);color:var(--gold);border:1px solid rgba(201,168,76,.3);}
.ps-badge.ready{background:rgba(46,204,113,.2);color:var(--green);border:1px solid rgba(46,204,113,.3);}
.ps-badge.waiting-b{background:rgba(255,255,255,.05);color:var(--dim);border:1px solid rgba(255,255,255,.1);}
.empty-slot{border:1px dashed rgba(255,255,255,.08);border-radius:12px;padding:10px 12px;text-align:center;font-size:11px;color:var(--dim);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME TABLE â€” CASINO FELT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#scGame{
  background:
    radial-gradient(ellipse 130% 90% at 50% 25%, #0d7a35 0%, #085c22 35%, #042e10 75%, #010e04 100%);
  overflow-y:auto;overflow-x:hidden;
  flex:1;display:flex;flex-direction:column;
  padding:0;
}
/* Felt grain texture */
#scGame::before{
  content:'';pointer-events:none;
  position:fixed;inset:0;z-index:0;opacity:.5;
  background-image:
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='3' height='3'%3E%3Ccircle cx='.8' cy='.8' r='.4' fill='rgba(0,0,0,.12)'/%3E%3C/svg%3E");
}
#scGame>*{position:relative;z-index:1;}
#scGame.hidden{display:none!important;}

/* Wood rail top border */
.table-rail{
  height:13px;flex-shrink:0;
  background:linear-gradient(180deg,#8b4c10 0%,#5c2e08 50%,#3a1a04 100%);
  box-shadow:0 3px 14px rgba(0,0,0,.6),inset 0 1px 0 rgba(255,190,90,.3),inset 0 -1px 0 rgba(0,0,0,.5);
}

/* Table header */
.table-hdr{
  background:transparent;
  padding:6px 14px 4px;display:flex;align-items:center;justify-content:space-between;
  flex-shrink:0;
}
.table-hdr-left{display:flex;align-items:center;gap:8px;}
.table-room-code{
  font-size:10px;color:rgba(255,215,100,.6);letter-spacing:3px;font-weight:bold;
  background:rgba(0,0,0,.35);border:1px solid rgba(255,180,60,.15);
  border-radius:10px;padding:3px 10px;
}
.my-balance{
  font-size:13px;font-weight:bold;color:#f5d978;
  background:rgba(0,0,0,.4);border:1px solid rgba(201,168,76,.45);
  border-radius:16px;padding:4px 13px;
  box-shadow:0 0 14px rgba(201,168,76,.12);
}
.my-balance::before{content:'ğŸ’° ';}
.game-status-badge{
  font-size:10px;letter-spacing:2px;padding:4px 10px;border-radius:12px;
  text-transform:uppercase;font-weight:bold;
}
.gsb-waiting{background:rgba(0,0,0,.3);color:rgba(255,255,255,.22);}
.gsb-betting{background:rgba(243,156,18,.18);color:#f39c12;border:1px solid rgba(243,156,18,.38);}
.gsb-playing{background:rgba(46,204,113,.14);color:#2ecc71;border:1px solid rgba(46,204,113,.32);}
.gsb-dealer{background:rgba(201,168,76,.14);color:var(--gold);border:1px solid rgba(201,168,76,.32);}
.gsb-results{background:rgba(155,89,182,.14);color:#c39bd3;border:1px solid rgba(155,89,182,.32);}

/* DEALER ZONE â€” rounded panel */
.dealer-zone{
  margin:8px 14px 0;
  background:rgba(0,0,0,.22);
  border:1px solid rgba(255,255,255,.08);
  border-radius:18px;
  padding:12px 14px 10px;flex-shrink:0;text-align:center;
  box-shadow:inset 0 2px 16px rgba(0,0,0,.3),0 2px 10px rgba(0,0,0,.35);
}
.dealer-lbl{
  font-size:9px;letter-spacing:5px;
  color:rgba(255,215,100,.42);
  text-transform:uppercase;margin-bottom:8px;
  font-family:Georgia,serif;
}
.dealer-cards{display:flex;gap:7px;justify-content:center;align-items:center;flex-wrap:wrap;min-height:72px;}
.dealer-score{
  text-align:center;font-size:12px;font-weight:bold;margin-top:6px;min-height:16px;
  color:rgba(255,255,255,.65);
}

/* Gold line divider */
.felt-line{
  height:1px;margin:8px 20px 0;flex-shrink:0;
  background:linear-gradient(90deg,transparent,rgba(255,200,80,.15) 25%,rgba(255,200,80,.28) 50%,rgba(255,200,80,.15) 75%,transparent);
}

/* OPPONENTS ZONE */
.opponents-zone{
  padding:6px 12px 4px;
  display:flex;gap:8px;overflow-x:auto;flex-shrink:0;
  scrollbar-width:none;
}
.opponents-zone::-webkit-scrollbar{display:none;}
.opponent-panel{
  background:rgba(0,0,0,.2);
  border:1px solid rgba(255,255,255,.08);border-radius:14px;
  padding:9px 10px 7px;flex-shrink:0;min-width:112px;max-width:134px;
  position:relative;transition:border-color .3s,box-shadow .3s;
}
.opponent-panel.active-turn{
  border-color:rgba(255,215,0,.5);
  box-shadow:0 0 20px rgba(255,215,0,.18),inset 0 0 10px rgba(255,215,0,.04);
}
.opponent-panel.bust-p{border-color:rgba(231,76,60,.32);}
.opponent-panel.win-p{border-color:rgba(46,204,113,.32);}
.op-header{display:flex;align-items:center;gap:6px;margin-bottom:7px;}
.op-avatar{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold;color:#000;flex-shrink:0;}
.op-name{font-size:11px;font-weight:bold;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;}
.op-cards{display:flex;gap:3px;flex-wrap:wrap;min-height:50px;align-items:center;margin-bottom:5px;}
.op-footer{display:flex;justify-content:space-between;align-items:center;}
.op-score{font-size:11px;font-weight:bold;}
.op-bet{font-size:10px;color:var(--gold);}
.op-status{font-size:9px;padding:2px 6px;border-radius:8px;font-weight:bold;}
.ops-betting{background:rgba(243,156,18,.15);color:#f39c12;}
.ops-stand{background:rgba(52,152,219,.15);color:#3498db;}
.ops-bust{background:rgba(231,76,60,.15);color:#e74c3c;}
.ops-bj{background:rgba(201,168,76,.2);color:var(--gold);}
.ops-playing{background:rgba(46,204,113,.15);color:var(--green);}
.ops-wait{background:rgba(255,255,255,.05);color:var(--dim);}

/* Turn indicator */
.turn-arrow{
  position:absolute;top:-10px;left:50%;transform:translateX(-50%);
  background:var(--gold);color:#000;font-size:8px;font-weight:bold;
  padding:2px 8px;border-radius:8px;letter-spacing:1px;white-space:nowrap;
  animation:arrowBounce .6s ease infinite alternate;
}
@keyframes arrowBounce{from{transform:translateX(-50%) translateY(0);}to{transform:translateX(-50%) translateY(-4px);}}

/* MY ZONE */
.my-zone{
  background:linear-gradient(0deg,rgba(0,0,0,.55) 0%,rgba(0,0,0,.15) 100%);
  border-top:1px solid rgba(255,255,255,.07);
  padding:8px 12px 14px;flex-shrink:0;margin-top:auto;
}
.my-lbl{font-size:9px;letter-spacing:3px;color:rgba(255,255,255,.4);text-transform:uppercase;margin-bottom:7px;display:flex;align-items:center;justify-content:space-between;}

/* My live score */
.my-live-score{
  font-size:32px;font-weight:900;line-height:1;
  transition:all .25s;display:inline-block;
}
.mls-safe{color:#2ecc71;text-shadow:0 0 15px rgba(46,204,113,.3);}
.mls-warn{color:#f39c12;text-shadow:0 0 15px rgba(243,156,18,.3);}
.mls-bj{color:var(--gold-l);animation:bjGlow .5s ease infinite alternate;}
@keyframes bjGlow{to{text-shadow:0 0 30px var(--glow);}}
.mls-bust{color:#e74c3c;animation:bustShk .35s ease;}
@keyframes bustShk{0%,100%{transform:none;}30%{transform:translateX(-5px);}70%{transform:translateX(5px);}}
.mls-up{animation:scoreUp .25s cubic-bezier(.175,.885,.32,1.275);}
@keyframes scoreUp{0%{transform:scale(.6)translateY(8px);opacity:.4;}100%{transform:scale(1)translateY(0);opacity:1;}}

.my-cards-row{display:flex;gap:7px;flex-wrap:wrap;align-items:center;min-height:80px;margin-bottom:8px;}

/* Message banner */
.msg-banner{
  text-align:center;font-size:15px;font-weight:bold;min-height:24px;
  text-shadow:0 0 20px currentColor;margin-bottom:6px;
}
.mb-win{color:#2ecc71;animation:msgWin .4s ease;}
.mb-lose{color:#e74c3c;}.mb-push{color:var(--gold);}
@keyframes msgWin{0%{transform:scale(.8);}60%{transform:scale(1.1);}100%{transform:scale(1);}}

/* CARDS */
.card{
  width:48px;height:68px;background:#fff;border-radius:6px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  font-weight:bold;color:#111;
  box-shadow:2px 4px 14px rgba(0,0,0,.7),inset 0 1px 0 rgba(255,255,255,.9);
  position:relative;flex-shrink:0;
}
/* Slide in from right â€” used for ALL new cards */
@keyframes cardSlide{
  0%  {transform:translateX(80px) rotate(12deg) scale(.75);opacity:0;}
  55% {transform:translateX(-5px) rotate(-1deg) scale(1.04);opacity:1;}
  80% {transform:translateX(2px) rotate(.5deg) scale(.98);}
  100%{transform:none;opacity:1;}
}
/* Faster slide for hit cards */
@keyframes cardHit{
  0%  {transform:translateX(70px) rotate(15deg) scale(.8);opacity:0;}
  60% {transform:translateX(-4px) rotate(-1deg) scale(1.03);opacity:1;}
  100%{transform:none;opacity:1;}
}
.card.deal-anim{animation:cardSlide .45s cubic-bezier(.175,.885,.32,1.275) both;}
.card.hit-anim {animation:cardHit  .3s cubic-bezier(.175,.885,.32,1.275) both;}
.card.win-glow{animation:winPulse .6s ease forwards;box-shadow:0 0 24px rgba(46,204,113,.7),2px 4px 14px rgba(0,0,0,.7);}
.card.bust-glow{box-shadow:0 0 20px rgba(231,76,60,.5),2px 4px 14px rgba(0,0,0,.7);}
.card.bj-glow{animation:bjPulse .5s ease infinite alternate;box-shadow:0 0 30px rgba(201,168,76,.9),2px 4px 14px rgba(0,0,0,.7);}
@keyframes winPulse{0%{transform:scale(1);}50%{transform:scale(1.12);}100%{transform:scale(1);}}
@keyframes bjPulse{to{box-shadow:0 0 50px rgba(201,168,76,1),2px 4px 14px rgba(0,0,0,.7);}}
.card.sm{width:38px;height:54px;}
.card.red-c{color:#c0392b;}
.card.back{background:linear-gradient(145deg,#1a3a9a,#0d2060);border:2px solid rgba(255,255,255,.15);}
.card.card-sideways{transform:rotate(90deg);transform-origin:center;flex-shrink:0;margin:0 8px;}
.card.back::after{content:'ğŸ‚ ';font-size:28px;color:rgba(255,255,255,.15);}
.card .suit{font-size:18px;line-height:1;}.card .rank{font-size:11px;font-weight:900;}
.card.sm .suit{font-size:14px;}.card.sm .rank{font-size:9px;}
.cn{position:absolute;font-size:8px;font-weight:bold;line-height:1.1;}
.tl{top:3px;left:4px;}.br{bottom:3px;right:4px;transform:rotate(180deg);}
.card.sm .cn{font-size:7px;}

/* RESULT OVERLAY on card */
.card-result{
  position:absolute;inset:0;border-radius:6px;
  display:flex;align-items:center;justify-content:center;
  font-size:8px;font-weight:bold;letter-spacing:.5px;
  animation:resultFade .4s ease;
}
@keyframes resultFade{from{opacity:0;}to{opacity:1;}}
.cr-win{background:rgba(46,204,113,.25);color:#2ecc71;border:1px solid rgba(46,204,113,.5);}
.cr-lose{background:rgba(231,76,60,.2);color:#e74c3c;border:1px solid rgba(231,76,60,.4);}
.cr-push{background:rgba(201,168,76,.2);color:var(--gold);border:1px solid rgba(201,168,76,.4);}

/* BETTING PANEL */
.bet-panel{
  background:linear-gradient(160deg,rgba(0,0,0,.4),rgba(0,0,0,.2));
  border:1px solid rgba(255,255,255,.07);border-radius:14px;
  padding:12px;margin-bottom:8px;
}
.bet-panel-title{font-size:10px;letter-spacing:2px;color:var(--dim);text-transform:uppercase;margin-bottom:10px;}
.bet-amount{font-size:22px;font-weight:bold;color:var(--gold-l);text-align:center;margin-bottom:8px;}
.bet-amount span{font-size:13px;color:var(--dim);}
.chips-row{display:flex;gap:7px;justify-content:center;margin-bottom:10px;}
.chip{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:10px;font-weight:900;cursor:pointer;color:#fff;position:relative;
  transition:transform .2s,box-shadow .2s;border:3px solid rgba(255,255,255,.18);
  text-shadow:0 1px 3px rgba(0,0,0,.8);}
.chip::after{content:'';position:absolute;inset:3px;border-radius:50%;border:2px dashed rgba(255,255,255,.18);}
.chip:hover{transform:translateY(-5px)scale(1.08);box-shadow:0 10px 22px rgba(0,0,0,.5);}
.chip.on{transform:translateY(-7px)scale(1.12);}
.c5{background:radial-gradient(circle at 35% 35%,#e74c3c,#8b1a1a);}
.c10{background:radial-gradient(circle at 35% 35%,#3498db,#1a5276);}
.c25{background:radial-gradient(circle at 35% 35%,#2ecc71,#1a6e3c);}
.c50{background:radial-gradient(circle at 35% 35%,#9b59b6,#5b1f8a);}
.c100{background:radial-gradient(circle at 35% 35%,#f0d060,#a07020);}

/* ACTION BUTTONS */
.actions-row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;padding:4px 0;}
.btn{
  display:inline-flex;align-items:center;justify-content:center;gap:6px;
  height:48px;padding:0 22px;border-radius:14px;font-family:inherit;
  font-size:13px;font-weight:800;letter-spacing:1px;text-transform:uppercase;
  cursor:pointer;border:none;position:relative;overflow:hidden;
  transition:transform .15s,box-shadow .15s,filter .15s;white-space:nowrap;
}
.btn::after{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,.12) 0%,transparent 60%);pointer-events:none;border-radius:inherit;}
.btn:hover{transform:translateY(-3px);filter:brightness(1.12);}
.btn:active{transform:translateY(1px) scale(.97);}
.btn:disabled{opacity:.28;cursor:not-allowed;transform:none!important;filter:none!important;}
/* Gold: bet/confirm actions */
.btn-gold{
  background:linear-gradient(165deg,#7a4e08,#c9a84c,#f0d060,#c9a84c,#7a4e08);
  color:#1a0e00;font-size:14px;font-weight:900;letter-spacing:2px;
  box-shadow:0 4px 22px rgba(201,168,76,.4),0 0 0 1px rgba(201,168,76,.5),inset 0 1px 0 rgba(255,255,255,.3);
}
/* Green: Hit */
.btn-green{
  background:linear-gradient(165deg,#0a5c1a,#1a8c30,#0a5c1a);
  color:#b8ffcc;box-shadow:0 4px 18px rgba(26,140,48,.35),0 0 0 1px #1a7a25,inset 0 1px 0 rgba(255,255,255,.15);
}
/* Red: Stand */
.btn-red{
  background:linear-gradient(165deg,#6a0a0a,#c0251e,#6a0a0a);
  color:#ffb8b8;box-shadow:0 4px 18px rgba(192,37,30,.35),0 0 0 1px #8a1512,inset 0 1px 0 rgba(255,255,255,.1);
}
/* Amber: Double */
.btn-amber{
  background:linear-gradient(165deg,#4a2e00,#c47b00,#4a2e00);
  color:#ffe0a0;box-shadow:0 4px 18px rgba(196,123,0,.3),0 0 0 1px #6a4400,inset 0 1px 0 rgba(255,255,255,.1);
}
/* Blue: Split */
.btn-blue{
  background:linear-gradient(165deg,#0a1e5a,#1848cc,#0a1e5a);
  color:#a8c8ff;box-shadow:0 4px 18px rgba(24,72,204,.3),0 0 0 1px #1a3088,inset 0 1px 0 rgba(255,255,255,.1);
}
/* Ghost: secondary */
.btn-ghost{background:rgba(255,255,255,.06);color:rgba(255,255,255,.5);box-shadow:0 0 0 1px rgba(255,255,255,.1);}
.btn-ghost:hover{background:rgba(255,255,255,.1);color:rgba(255,255,255,.8);}
.btn-pill{border-radius:999px;}
.btn-sm{height:36px;padding:0 14px;font-size:11px;font-weight:700;}
.btn-lg{height:56px;padding:0 34px;font-size:15px;font-weight:900;}
.btn-full{width:100%;}

/* SPLIT HAND LAYOUT */
.split-hands-container{display:flex;gap:10px;width:100%;}
.split-hand{flex:1;border:2px solid rgba(255,255,255,.1);border-radius:12px;padding:8px;min-height:90px;}
.split-hand.active-sh{border-color:rgba(255,215,0,.6);box-shadow:0 0 14px rgba(255,215,0,.18);}
.split-hand.done-sh{opacity:.55;border-color:rgba(255,255,255,.06);}
.split-hand-lbl{font-size:9px;letter-spacing:2px;color:rgba(255,255,255,.35);text-transform:uppercase;margin-bottom:6px;}
.split-cards{display:flex;gap:4px;flex-wrap:wrap;align-items:center;min-height:68px;}
/* Horizontal hit card on split */
.card.card-sideways{transform:rotate(90deg);transform-origin:center;margin:0 12px;}

/* FIREBASE SETUP MODAL */
#setupModal{position:fixed;inset:0;z-index:9500;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;padding:16px;overflow-y:auto;}
#setupModal.show{display:flex;}
.setup-box{background:linear-gradient(160deg,#0e1020,#141828);border:1px solid rgba(201,168,76,.25);border-radius:20px;padding:22px;width:100%;max-width:400px;box-shadow:0 20px 60px rgba(0,0,0,.8);}
.setup-title{font-size:15px;font-weight:bold;color:var(--gold);margin-bottom:6px;}
.setup-sub{font-size:11px;color:var(--dim);margin-bottom:14px;line-height:1.6;}
.setup-step{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:10px;margin-bottom:8px;}
.sn{width:20px;height:20px;border-radius:50%;background:var(--gold);color:#000;font-weight:900;font-size:10px;display:inline-flex;align-items:center;justify-content:center;margin-right:6px;}
.setup-step p{font-size:11px;color:var(--text);line-height:1.6;display:inline;}
.setup-step a{color:var(--gold);}
.cfg-ta{width:100%;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:10px;font-size:10px;font-family:monospace;color:#7ec8e3;outline:none;min-height:80px;resize:vertical;margin-top:8px;}
.cfg-err{color:#e74c3c;font-size:11px;margin-top:5px;display:none;}

/* Stats bar */
.stats-bar{
  display:flex;gap:6px;padding:4px 12px 6px;flex-shrink:0;overflow-x:auto;
  scrollbar-width:none;border-bottom:1px solid rgba(255,255,255,.05);
}
.stats-bar::-webkit-scrollbar{display:none;}
.stat-pill{
  background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.07);
  border-radius:10px;padding:4px 10px;flex-shrink:0;
  display:flex;flex-direction:column;align-items:center;gap:1px;min-width:52px;
}
.stat-lbl{font-size:8px;letter-spacing:1.5px;color:rgba(255,255,255,.3);text-transform:uppercase;}
.stat-val{font-size:12px;font-weight:bold;color:var(--text);}

/* TOAST */
.toast{position:fixed;top:70px;left:50%;transform:translateX(-50%)translateY(-12px);background:rgba(4,8,15,.95);border:1px solid rgba(201,168,76,.35);border-radius:22px;padding:8px 20px;font-size:12px;color:var(--gold-l);z-index:9998;pointer-events:none;transition:all .35s cubic-bezier(.175,.885,.32,1.275);white-space:nowrap;opacity:0;box-shadow:0 8px 30px rgba(0,0,0,.6);}
.toast.show{opacity:1;transform:translateX(-50%)translateY(0);}

/* JACKPOT */
.jp{position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;animation:jpIn .3s ease;}
@keyframes jpIn{from{opacity:0;transform:scale(.9);}to{opacity:1;transform:none;}}
.jp-txt{font-size:48px;font-weight:900;color:var(--gold);letter-spacing:4px;animation:jpP .5s ease infinite alternate;}
@keyframes jpP{to{text-shadow:0 0 60px var(--gold),0 0 120px rgba(201,168,76,.4);transform:scale(1.05);}}
.jp-sub{font-size:22px;color:#fff;text-align:center;}

/* Results overlay */
.results-overlay{
  position:absolute;inset:0;background:rgba(0,0,0,.8);z-index:200;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:10px;animation:jpIn .3s ease;padding:20px;
}
.results-title{font-size:20px;font-weight:bold;color:var(--gold);letter-spacing:3px;margin-bottom:6px;}
.results-list{width:100%;max-width:320px;display:flex;flex-direction:column;gap:6px;}
.result-row{
  display:flex;align-items:center;gap:10px;
  padding:10px 12px;border-radius:12px;
  background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.07);
}
.rr-avatar{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:bold;color:#000;flex-shrink:0;}
.rr-name{flex:1;font-size:12px;font-weight:bold;}
.rr-hand{font-size:11px;color:var(--dim);}
.rr-result{font-weight:bold;font-size:13px;}
.rr-win{color:#2ecc71;}.rr-lose{color:#e74c3c;}.rr-push{color:var(--gold);}.rr-bj{color:var(--gold-l);}
.rr-payout{font-size:11px;color:var(--dim);}

/* Live pulse */
.live-dot{display:inline-flex;align-items:center;gap:4px;font-size:10px;color:#2ecc71;}
.live-dot::before{content:'';width:7px;height:7px;border-radius:50%;background:#2ecc71;animation:lp 1.2s ease infinite;}
@keyframes lp{0%,100%{opacity:1;transform:scale(1);}50%{opacity:.3;transform:scale(1.4);}}

::-webkit-scrollbar{width:3px;height:3px;}
::-webkit-scrollbar-thumb{background:var(--gold-d);border-radius:3px;}
@keyframes slideUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
</style>
</head>
<body>
<div id="pt"></div>

<!-- â•â•â•â•â•â•â•â• WELCOME â•â•â•â•â•â•â•â• -->
<div class="fullscreen" id="scWelcome">
  <div class="wl-suits">â™  â™¥ â™¦ â™£</div>
  <div class="wl-title">BlackJack</div>
  <div class="wl-sub">Multijugador Â· Mesa compartida</div>
  <div class="glass-card">
    <div class="field-lbl">Tu nombre en la mesa</div>
    <input class="field" id="nameInput" type="text" placeholder="Ej: El Shark ğŸ¦ˆ" maxlength="18" autocomplete="off">
    <button class="btn btn-gold btn-pill btn-full btn-lg" onclick="goLobby()">ğŸƒ Entrar</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• LOBBY â•â•â•â•â•â•â•â• -->
<div class="fullscreen hidden" id="scLobby">
  <div class="lobby-card">
    <div class="lobby-header">
      <div class="lb-avatar" id="lobbyAvatar"></div>
      <div>
        <div class="lb-player-name" id="lobbyName"></div>
        <div class="lb-player-bal">ğŸ’° $<span id="lobbyBal">1000</span></div>
      </div>
    </div>

    <button class="btn btn-gold btn-pill btn-full btn-lg" onclick="createRoom()" style="margin-bottom:8px">
      ğŸ² Crear Mesa Multijugador
    </button>

    <button class="btn btn-green btn-pill btn-full" onclick="playSolo()" style="margin-bottom:12px;height:44px;font-size:13px;letter-spacing:1.5px">
      ğŸ¤– Jugar Solo vs Dealer
    </button>

    <div class="or-divider"><span>o unirse con cÃ³digo</span></div>

    <div class="join-row">
      <input class="field" id="codeInput" type="text" placeholder="ABC123" maxlength="6" autocomplete="off" style="text-transform:uppercase;letter-spacing:4px;">
      <button class="btn btn-blue btn-pill" onclick="joinRoom()" style="height:52px;padding:0 18px;font-size:13px">Unirse</button>
    </div>

    <div style="display:flex;justify-content:center;margin-top:10px">
      <div id="fbStatus" style="font-size:11px;color:var(--dim);text-align:center;padding:4px 0">â³ Conectando...</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• WAITING ROOM â•â•â•â•â•â•â•â• -->
<div class="fullscreen hidden" id="scWaiting">
  <div class="room-code-display">
    <div class="room-code-lbl">CÃ³digo de la sala</div>
    <div class="room-code" id="displayCode" onclick="copyRoomCode()" title="Toca para copiar" style="cursor:pointer;user-select:all;">â€”â€”</div>
    <div class="room-code-sub" id="codeCopySub">ğŸ‘† Toca para copiar el cÃ³digo</div>
  </div>
  <div class="waiting-card">
    <div class="waiting-title">Jugadores en la mesa (<span id="playerCount">0</span>/6)</div>
    <div class="player-list" id="playerList"></div>
    <div id="hostControls" style="display:none">
      <button class="btn btn-gold btn-pill btn-full btn-lg" id="startBtn" onclick="hostStartGame()">
        ğŸƒ Empezar Partida
      </button>
      <div style="font-size:10px;color:var(--dim);text-align:center;margin-top:7px">Solo tÃº (anfitriÃ³n) puedes iniciar</div>
    </div>
    <div id="guestWait" style="display:none;text-align:center;font-size:12px;color:var(--dim);padding:10px">
      Esperando que el anfitriÃ³n inicie la partida...
    </div>
    <button class="btn btn-ghost btn-pill btn-sm btn-full" onclick="leaveRoom()" style="margin-top:10px">
      â† Salir de la sala
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• GAME TABLE â•â•â•â•â•â•â•â• -->
<div id="scGame" class="hidden" style="position:relative;">

  <!-- Wood rail top -->
  <div class="table-rail"></div>

  <!-- Header -->
  <div class="table-hdr">
    <div class="table-hdr-left">
      <span class="live-dot"></span>
      <span class="table-room-code" id="gameCode"></span>
    </div>
    <div class="game-status-badge gsb-waiting" id="statusBadge">Esperando</div>
    <div class="my-balance" id="myBalance">$1,000</div>
  </div>

  <!-- Stats bar (solo mode only) -->
  <div class="stats-bar" id="statsBar" style="display:none"></div>

  <!-- DEALER -->
  <div class="dealer-zone">
    <div class="dealer-lbl">ğŸ¦ Dealer</div>
    <div class="dealer-cards" id="dealerCards"></div>
    <div class="dealer-score" id="dealerScore"></div>
  </div>

  <!-- OPPONENTS -->
  <div class="felt-line"></div>
  <div class="opponents-zone" id="opponentsZone"></div>

    <!-- MY ZONE -->
    <div class="my-zone">
      <div class="my-lbl">
        <span>ğŸ‘¤ TÃº Â· <span id="myName2"></span></span>
        <div style="display:flex;align-items:center;gap:8px;">
          <div id="myBetChip" style="display:none"></div>
          <span class="my-live-score mls-safe" id="myLiveScore" style="display:none">0</span>
        </div>
      </div>

      <!-- Normal hand / split container (JS controls which to show) -->
      <div class="my-cards-row" id="myCards">
        <div style="color:var(--dim);font-size:12px;font-style:italic">Las cartas aparecerÃ¡n aquÃ­...</div>
      </div>

      <div class="msg-banner" id="msgBanner"></div>

      <!-- BETTING PANEL -->
      <div class="bet-panel" id="betPanel" style="display:none">
        <div class="bet-panel-title">Coloca tu apuesta</div>
        <div class="bet-amount"><span>$</span><span id="myBetDisplay">0</span></div>
        <div class="chips-row">
          <div class="chip c5"   onclick="addBet(5)">$5</div>
          <div class="chip c10"  onclick="addBet(10)">$10</div>
          <div class="chip c25"  onclick="addBet(25)">$25</div>
          <div class="chip c50"  onclick="addBet(50)">$50</div>
          <div class="chip c100" onclick="addBet(100)">$100</div>
        </div>
        <div class="actions-row">
          <button class="btn btn-ghost btn-pill btn-sm" onclick="clearBet()">âœ• Limpiar</button>
          <button class="btn btn-gold btn-pill" onclick="confirmBet()" id="betConfirmBtn">âœ… Apostar</button>
        </div>
      </div>

      <!-- PLAY ACTIONS -->
      <div class="actions-row" id="playActions" style="display:none">
        <button class="btn btn-red  btn-pill" id="btnStand"  onclick="playerStand()">âœ‹ Plantar</button>
        <button class="btn btn-amber btn-pill" id="btnDouble" onclick="playerDouble()">âœ•2 Doble</button>
        <button class="btn btn-blue  btn-pill" id="btnSplit"  onclick="playerSplit()" style="display:none">âœ‚ï¸ Dividir</button>
        <button class="btn btn-green btn-pill" id="btnHit"    onclick="playerHit()">ğŸ‘† Pedir</button>
      </div>

      <!-- WAITING MESSAGE -->
      <div id="waitMsg" style="text-align:center;font-size:12px;color:var(--dim);padding:8px;display:none"></div>

      <!-- HOST CONTROLS IN GAME -->
      <div id="hostGameCtrl" style="display:none;text-align:center;margin-top:8px">
        <button class="btn btn-ghost btn-pill btn-sm" onclick="hostNextRound()">â†º Nueva ronda</button>
        <button class="btn btn-ghost btn-pill btn-sm" onclick="leaveRoom()" style="margin-left:6px">â† Salir</button>
      </div>
      <div id="guestGameCtrl" style="display:none;display:flex;justify-content:flex-end;margin-top:8px">
        <button class="btn btn-ghost btn-pill btn-sm" onclick="leaveRoom()">â† Salir</button>
      </div>
      <!-- SOLO EXIT BUTTON -->
      <div id="soloExitBtn" style="display:none;text-align:center;margin-top:8px">
        <button class="btn btn-ghost btn-pill btn-sm" onclick="leaveRoom()">â† Salir al lobby</button>
      </div>
    </div>

  <!-- Results overlay -->
  <div id="resultsOverlay" style="display:none;position:absolute;inset:0;background:rgba(0,0,0,.88);z-index:200;flex-direction:column;align-items:center;justify-content:center;gap:10px;padding:20px;overflow-y:auto;">
    <div class="results-title">ğŸ† RESULTADOS</div>
    <div class="results-list" id="resultsList"></div>
    <!-- Solo mode button (always visible in solo) -->
    <div id="soloNextBtn" style="display:none;margin-top:12px;width:100%;max-width:320px">
      <button class="btn btn-gold btn-pill btn-lg btn-full" onclick="soloNextRound()" style="font-size:16px;letter-spacing:3px">
        ğŸƒ NUEVA RONDA
      </button>
      <button class="btn btn-ghost btn-pill btn-sm btn-full" onclick="leaveRoom()" style="margin-top:8px">â† Salir al lobby</button>
    </div>
    <!-- Multiplayer host button -->
    <div id="hostNextBtn" style="display:none;margin-top:12px;width:100%;max-width:320px">
      <button class="btn btn-gold btn-pill btn-lg btn-full" onclick="hostNextRound()" style="font-size:16px;letter-spacing:3px">
        ğŸƒ NUEVA RONDA
      </button>
      <div style="font-size:10px;color:var(--dim);text-align:center;margin-top:6px">Solo el anfitriÃ³n puede iniciar</div>
      <button class="btn btn-ghost btn-pill btn-sm btn-full" onclick="leaveRoom()" style="margin-top:8px">â† Salir de la mesa</button>
    </div>
    <!-- Multiplayer guest waiting -->
    <div id="guestNextMsg" style="display:none;margin-top:8px;text-align:center;width:100%;max-width:320px">
      <div style="font-size:13px;color:var(--dim);padding:12px 20px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:12px">
        â³ Esperando que el anfitriÃ³n inicie la siguiente ronda...
      </div>
      <button class="btn btn-ghost btn-pill btn-sm btn-full" onclick="leaveRoom()" style="margin-top:8px">â† Salir de la mesa</button>
    </div>
  </div>
</div>

<div class="toast" id="toastEl"></div>

<!-- PWA Install Banner -->
<div id="pwaInstallBanner" style="display:none;position:fixed;bottom:0;left:0;right:0;z-index:9990;padding:12px 16px;background:linear-gradient(135deg,#0a3520,#0d5c2a);border-top:1px solid rgba(201,168,76,.3);animation:slideUp .4s ease;">
  <div style="display:flex;align-items:center;gap:12px;max-width:500px;margin:0 auto;">
    <div style="font-size:32px;flex-shrink:0">ğŸƒ</div>
    <div style="flex:1">
      <div style="font-size:13px;font-weight:bold;color:#f0d060">Instalar BlackJack Royale</div>
      <div style="font-size:11px;color:rgba(255,255,255,.55)">Juega desde tu pantalla de inicio sin navegador</div>
    </div>
    <button class="btn btn-gold btn-pill btn-sm" onclick="installPWA()" style="flex-shrink:0">Instalar</button>
    <button onclick="document.getElementById('pwaInstallBanner').style.display='none'" style="background:none;border:none;color:rgba(255,255,255,.4);font-size:18px;cursor:pointer;padding:4px;flex-shrink:0">âœ•</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const INIT_BAL = 1000;
const SUITS = ['â™ ','â™¥','â™¦','â™£'];
const RANKS = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
const REDS_S = new Set(['â™¥','â™¦']);
const AVATAR_COLORS = ['#e74c3c','#e67e22','#f1c40f','#2ecc71','#1abc9c','#3498db','#9b59b6','#e91e63','#ff5722','#00bcd4'];
const GAME_PATH = 'casino-bj'; // Datos del casino â€” separados de BetManager Pro

const FIREBASE_CFG = {"apiKey":"AIzaSyD51pg5fns6BgOeCpTj5AA7vwZK1JobAZs","authDomain":"casino-royale-c7eec.firebaseapp.com","databaseURL":"https://casino-royale-c7eec-default-rtdb.firebaseio.com","projectId":"casino-royale-c7eec","storageBucket":"casino-royale-c7eec.firebasestorage.app","messagingSenderId":"129065809800","appId":"1:129065809800:web:76d1deae511361fd602c3d"};
let db = null, fbReady = false;
let myId = '', myName = '', myColor = '';
let myBal = INIT_BAL;
let roomCode = '', isHost = false;
let roomRef = null, roomListener = null;
let currentRoom = null;
let myBet = 0, myCardIdx = 0; // index into pre-dealt cards

// â”€â”€ SOLO MODE STATE â”€â”€
let soloMode = false;
let soloDeck = [], soloPlayerHand = [], soloDealerHand = [], soloBet = 0;
let soloPhase = 'idle'; // idle | betting | playing | dealer | results
let soloSplitHand = null, soloSplitBet = 0, soloActiveSplit = 0, soloSplitCardOffset = 0;
let soloStats = { wins:0, losses:0, pushes:0, blackjacks:0, streak:0, bestStreak:0, handsPlayed:0, totalProfit:0 };
let mpStats   = { wins:0, losses:0, pushes:0, blackjacks:0, streak:0, bestStreak:0, handsPlayed:0, totalProfit:0 };

// â”€â”€ Web Audio for sound effects â”€â”€
let audioCtx = null;
function getAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}
function playTone(freq, dur=0.08, type='triangle', vol=0.18, delay=0) {
  try {
    const ctx = getAudio();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.frequency.value = freq; o.type = type;
    g.gain.setValueAtTime(0, ctx.currentTime + delay);
    g.gain.linearRampToValueAtTime(vol, ctx.currentTime + delay + 0.01);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + delay + dur);
    o.start(ctx.currentTime + delay);
    o.stop(ctx.currentTime + delay + dur + 0.01);
  } catch(e) {}
}
function sfxCard() {
  playTone(900, 0.04, 'square', 0.08);
  playTone(650, 0.06, 'triangle', 0.10, 0.03);
}
function sfxChip() {
  playTone(1100, 0.05, 'square', 0.1);
  playTone(800, 0.07, 'triangle', 0.08, 0.04);
}
function sfxWin() {
  [523,659,784,1047].forEach((f,i) => playTone(f, 0.15, 'sine', 0.2, i*0.1));
}
function sfxBlackjack() {
  [523,659,784,1047,1319].forEach((f,i) => playTone(f, 0.2, 'sine', 0.25, i*0.08));
}
function sfxLose() {
  playTone(300, 0.3, 'sawtooth', 0.15);
  playTone(220, 0.4, 'sawtooth', 0.12, 0.15);
}
function sfxDealerFlip() {
  playTone(440, 0.1, 'triangle', 0.15);
  playTone(330, 0.12, 'triangle', 0.1, 0.08);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PERSISTENCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveLocal() {
  localStorage.setItem('bjmp_player', JSON.stringify({id:myId, name:myName, color:myColor, bal:myBal}));
}
function saveStats() {
  localStorage.setItem('bjmp_stats', JSON.stringify(soloStats));
}
function saveMpStats() {
  localStorage.setItem('bjmp_mpstats', JSON.stringify(mpStats));
}
function loadStats() {
  const s = localStorage.getItem('bjmp_stats');
  if (s) try { Object.assign(soloStats, JSON.parse(s)); } catch(e) {}
  const m = localStorage.getItem('bjmp_mpstats');
  if (m) try { Object.assign(mpStats, JSON.parse(m)); } catch(e) {}
}
function renderStatsBar() {
  const el = document.getElementById('statsBar');
  if (!el) return;
  const wr = soloStats.handsPlayed > 0 ? Math.round(soloStats.wins * 100 / soloStats.handsPlayed) : 0;
  const streakIcon = soloStats.streak > 0 ? 'ğŸ”¥' : soloStats.streak < 0 ? 'â„ï¸' : 'â€”';
  const streakVal = soloStats.streak > 0 ? `+${soloStats.streak}` : soloStats.streak < 0 ? `${soloStats.streak}` : '0';
  const profit = soloStats.totalProfit;
  el.innerHTML = `
    <div class="stat-pill"><span class="stat-lbl">Manos</span><span class="stat-val">${soloStats.handsPlayed}</span></div>
    <div class="stat-pill"><span class="stat-lbl">Win%</span><span class="stat-val" style="color:${wr>=50?'#2ecc71':'#e74c3c'}">${wr}%</span></div>
    <div class="stat-pill"><span class="stat-lbl">Racha</span><span class="stat-val">${streakIcon} ${streakVal}</span></div>
    <div class="stat-pill"><span class="stat-lbl">BJ</span><span class="stat-val" style="color:#f0d060">âš¡${soloStats.blackjacks}</span></div>
    <div class="stat-pill"><span class="stat-lbl">P/L</span><span class="stat-val" style="color:${profit>=0?'#2ecc71':'#e74c3c'}">${profit>=0?'+':''}$${profit}</span></div>
  `;
}
function loadLocal() {
  const d = localStorage.getItem('bjmp_player');
  if (d) try {
    const p = JSON.parse(d);
    // NEVER reuse myId across sessions - always fresh to avoid collision
    myName = p.name || ''; myColor = p.color || ''; myBal = p.bal || INIT_BAL;
  } catch(e) {}
  // Always generate a fresh session ID
  myId = 'p_' + Date.now() + '_' + Math.random().toString(36).slice(2,8);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyConfig() {
  const raw = document.getElementById('cfgInput').value.trim();
  const errEl = document.getElementById('cfgErr');
  try {
    const cfg = JSON.parse(raw);
    if (!cfg.apiKey || !cfg.databaseURL) throw new Error('Faltan campos');
    localStorage.setItem('bjmp_fbcfg', JSON.stringify(cfg));
    errEl.style.display = 'none';
    initFirebase(cfg);
    closeSetup();
    toast('ğŸ”¥ Firebase conectado â€” Â¡Multijugador activo!', 3000);
  } catch(e) { errEl.style.display = 'block'; }
}
function initFirebase(cfg) {
  try {
    if (!cfg || !cfg.apiKey) throw new Error('Config vacÃ­o o incompleto');
    // Add databaseURL if missing (common issue)
    if (!cfg.databaseURL && cfg.projectId) {
      cfg.databaseURL = 'https://' + cfg.projectId + '-default-rtdb.firebaseio.com';
      console.log('databaseURL construido:', cfg.databaseURL);
    }
    if (firebase.apps.length === 0) {
      firebase.initializeApp(cfg);
    }
    db = firebase.database();
    fbReady = true;
    updateFbStatus();
    console.log('âœ… Firebase OK:', cfg.projectId);
  } catch(e) {
    fbReady = false;
    db = null;
    updateFbStatus();
    console.error('âŒ Firebase error:', e.message);
    // Show error in lobby when it's visible
    setTimeout(() => showFbErr(e.message), 500);
  }
}

function updateFbStatus() {
  const el = document.getElementById('fbStatus');
  if (!el) return;
  if (fbReady && db) {
    el.textContent = 'âœ… Firebase Conectado';
    el.style.color = '#2ecc71';
  } else {
    el.textContent = 'âŒ Sin Firebase';
    el.style.color = '#e74c3c';
  }
}

function showFbErr(msg) {
  const el = document.getElementById('fbStatus');
  if (el) { el.textContent = 'âš ï¸ Error Firebase'; el.style.color = '#f39c12'; }
  toast('âš ï¸ ' + msg, 8000);
}
function showSetup() { document.getElementById('setupModal').classList.add('show'); }
function closeSetup() { document.getElementById('setupModal').classList.remove('show'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastT;
function toast(msg, dur=2500) {
  const el = document.getElementById('toastEl');
  el.textContent = msg; el.classList.add('show');
  clearTimeout(toastT); toastT = setTimeout(() => el.classList.remove('show'), dur);
}
function getColor(name) {
  let h = 0;
  for (let i = 0; i < name.length; i++) h = (h * 31 + name.charCodeAt(i)) % AVATAR_COLORS.length;
  return AVATAR_COLORS[h];
}
function getInitial(name) { return (name || '?')[0].toUpperCase(); }
function makeAvatar(name, color, size=32) {
  const el = document.createElement('div');
  el.style.cssText = `width:${size}px;height:${size}px;border-radius:50%;background:${color};display:flex;align-items:center;justify-content:center;font-size:${size*0.42}px;font-weight:bold;color:#000;flex-shrink:0;`;
  el.textContent = getInitial(name);
  return el;
}
function show(id) { const el = document.getElementById(id); if(el) { el.classList.remove('hidden'); el.style.display = ''; } }
function hide(id) { const el = document.getElementById(id); if(el) { el.classList.add('hidden'); el.style.display = 'none!important'; } }
function showFlex(id) { const el = document.getElementById(id); if(el) { el.style.display = 'flex'; el.classList.remove('hidden'); } }
function hideEl(id) { const el = document.getElementById(id); if(el) el.style.display = 'none'; }
function showEl(id, d='block') { const el = document.getElementById(id); if(el) el.style.display = d; }
function burst(x, y, n=18) {
  const p = document.getElementById('pt');
  const colors = ['#c9a84c','#f0d060','#fff','#2ecc71','#e74c3c'];
  for (let i = 0; i < n; i++) {
    const el = document.createElement('div'); el.className = 'p';
    const sz = 4 + Math.random() * 9, c = colors[~~(Math.random() * colors.length)];
    el.style.cssText = `width:${sz}px;height:${sz}px;background:${c};left:${x+(Math.random()-.5)*130}px;top:${y}px;animation-duration:${1.4+Math.random()*1.8}s;animation-delay:${Math.random()*.3}s;`;
    p.appendChild(el); el.addEventListener('animationend', () => el.remove());
  }
}
function bigBurst() { for(let i=0;i<5;i++) setTimeout(() => burst(Math.random()*window.innerWidth, 80+Math.random()*80, 28), i*200); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DECK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildShuffledDeck(numDecks = 4) {
  const deck = [];
  for (let d = 0; d < numDecks; d++)
    SUITS.forEach(s => RANKS.forEach(r => deck.push({r, s})));
  for (let i = deck.length - 1; i > 0; i--) {
    const j = ~~(Math.random() * (i + 1));
    [deck[i], deck[j]] = [deck[j], deck[i]];
  }
  return deck;
}
function cardVal(c) {
  if (['J','Q','K'].includes(c.r)) return 10;
  if (c.r === 'A') return 11;
  return +c.r;
}
function toArr(x) {
  if (!x) return [];
  if (Array.isArray(x)) return x;
  // Firebase converts arrays to objects with numeric keys
  return Object.keys(x).sort((a,b)=>+a-+b).map(k=>x[k]);
}
function handTotal(hand) {
  const h = toArr(hand);
  let t = 0, aces = 0;
  h.forEach(c => { if(!c)return; t += cardVal(c); if (c.r === 'A') aces++; });
  while (t > 21 && aces > 0) { t -= 10; aces--; }
  return t;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WELCOME â†’ LOBBY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goLobby() {
  const inp = document.getElementById('nameInput');
  const name = inp.value.trim();
  if (!name) { inp.focus(); inp.style.borderColor = '#e74c3c'; return; }
  inp.style.borderColor = '';
  myName = name;
  if (!myId) myId = 'p_' + Date.now() + '_' + Math.random().toString(36).slice(2,6);
  myColor = getColor(name);
  saveLocal();

  // Update lobby UI
  const av = document.getElementById('lobbyAvatar');
  av.style.cssText = `width:40px;height:40px;border-radius:50%;background:${myColor};display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:bold;color:#000;`;
  av.textContent = getInitial(name);
  document.getElementById('lobbyName').textContent = name;
  document.getElementById('lobbyBal').textContent = myBal.toLocaleString();
  updateFbStatus();

  hide('scWelcome');
  show('scLobby');
  document.getElementById('nameInput').removeEventListener('keydown', handleEnter);
}

function handleEnter(e) { if (e.key === 'Enter') goLobby(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROOM MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 6; i++) code += chars[~~(Math.random() * chars.length)];
  return code;
}

async function createRoom() {
  if (!db || !fbReady) {
    toast("âš ï¸ Conectando a Firebase, espera un momento...", 2000);
    setTimeout(() => { if (db && fbReady) createRoom(); }, 1500);
    return;
  }
  roomCode = genCode();
  isHost = true;
  try {
    await joinRoomDb(roomCode, true);
  } catch(e) {
    toast("âŒ Error al crear sala: " + e.message, 3000);
  }
}

async function joinRoom() {
  if (!db || !fbReady) {
    toast("âš ï¸ Conectando a Firebase, espera un momento...", 2000);
    // Retry after short delay
    setTimeout(() => { if (db && fbReady) joinRoom(); }, 1500);
    return;
  }
  const code = document.getElementById("codeInput").value.trim().toUpperCase();
  if (code.length < 4) { toast("âš ï¸ Ingresa el cÃ³digo completo de la sala"); return; }
  try {
    const snap = await db.ref(GAME_PATH + "/" + code).once("value");
    if (!snap.exists()) { toast("âŒ Sala no encontrada. Verifica el cÃ³digo."); return; }
    const room = snap.val();
    // Allow joining in lobby status only (game not started)
    // If game is in progress, they can join the next round
    if (room.status !== "lobby") {
      toast("â³ La partida ya iniciÃ³. Puedes unirte en la prÃ³xima ronda.", 3500);
      return;
    }
    const pCount = Object.keys(room.players || {}).length;
    if (pCount >= 6) { toast("âŒ La sala estÃ¡ llena (mÃ¡ximo 6 jugadores)."); return; }
    roomCode = code;
    isHost = false;
    await joinRoomDb(code, false);
  } catch(e) {
    toast("âŒ Error: " + e.message, 3000);
  }
}

async function joinRoomDb(code, creating) {
  const playerData = {
    name: myName, color: myColor, bal: myBal,
    status: 'lobby', bet: 0, hand: [], cardPool: [],
    result: null, payout: 0, order: Date.now()
  };

  if (creating) {
    await db.ref(`${GAME_PATH}/${code}`).set({
      host: myId, status: 'lobby', round: 0,
      deck: [], dealerHand: [], dealerRevealed: false,
      currentTurn: null, turnOrder: [],
      players: { [myId]: playerData }, createdAt: Date.now()
    });
  } else {
    await db.ref(`${GAME_PATH}/${code}/players/${myId}`).set(playerData);
  }

  // Presence: remove on disconnect
  db.ref(`${GAME_PATH}/${code}/players/${myId}`).onDisconnect().remove();

  hide('scLobby');
  showWaiting(code);
  listenRoom(code);
}

function showWaiting(code) {
  document.getElementById('displayCode').textContent = code;
  show('scWaiting');
}

function leaveRoom() {
  if (roomRef) { roomRef.off(); roomRef = null; }
  if (!soloMode && db && roomCode) db.ref(`${GAME_PATH}/${roomCode}/players/${myId}`).remove();
  soloMode = false;
  soloPhase = 'idle';
  roomCode = ''; isHost = false; currentRoom = null;
  myBet = 0; soloBet = 0;
  document.getElementById('resultsOverlay').style.display = 'none';
  hide('scWaiting');
  hide('scGame');
  show('scLobby');
  document.getElementById('lobbyBal').textContent = myBal.toLocaleString();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROOM LISTENER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function listenRoom(code) {
  if (roomRef) roomRef.off();
  roomRef = db.ref(`${GAME_PATH}/${code}`);
  roomRef.on('value', snap => {
    if (!snap.exists()) { toast('La sala fue cerrada.'); leaveRoom(); return; }
    currentRoom = snap.val();
    handleRoomUpdate(currentRoom);
  });
}

let _lastAdvance = 0; // debounce guard
function safeAdvanceTurn() {
  const now = Date.now();
  if (now - _lastAdvance < 1200) return; // ignore if called within 1.2s
  _lastAdvance = now;
  advanceTurn();
}

function handleRoomUpdate(room) {
  // Always ensure correct screen is showing
  switch(room.status) {
    case 'lobby':
      renderWaiting(room);
      break;
    case 'betting':
      // Make sure we're on game screen, not waiting screen
      hide('scWaiting');
      renderBetting(room);
      break;
    case 'playing':
      hide('scWaiting');
      renderPlaying(room);
      // Host: detect when current player finished (guest actions only)
      if (isHost && room.currentTurn && room.currentTurn !== myId) {
        const p = room.players?.[room.currentTurn];
        const s = p?.status || '';
        if (s === 'bust' || s === 'stand' || s === 'blackjack') {
          setTimeout(safeAdvanceTurn, 700);
        }
      }
      break;
    case 'dealer':
      hide('scWaiting');
      renderDealerTurn(room);
      break;
    case 'results':
      hide('scWaiting');
      renderResults(room);
      break;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WAITING ROOM RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderWaiting(room) {
  // Always ensure correct screens
  hide('scGame');
  show('scWaiting');

  const players = room.players || {};
  const ids = Object.keys(players).sort((a,b) => (players[a].order||0)-(players[b].order||0));
  const list = document.getElementById('playerList');
  list.innerHTML = '';
  document.getElementById('playerCount').textContent = ids.length;

  ids.forEach(pid => {
    const p = players[pid];
    const row = document.createElement('div'); row.className = 'player-slot';
    const av = makeAvatar(p.name, p.color, 32);
    const nm = document.createElement('div'); nm.className = 'ps-name'; nm.textContent = p.name + (pid===myId?' (tÃº)':'');
    const badge = document.createElement('div');
    if (pid === room.host) { badge.className = 'ps-badge host'; badge.textContent = 'ğŸ‘‘ AnfitriÃ³n'; }
    else { badge.className = 'ps-badge ready'; badge.textContent = 'âœ… Listo'; }
    row.appendChild(av); row.appendChild(nm); row.appendChild(badge);
    list.appendChild(row);
  });

  // Add empty slots
  for (let i = ids.length; i < 6; i++) {
    const empty = document.createElement('div'); empty.className = 'empty-slot';
    empty.textContent = `Lugar ${i+1} libre...`;
    list.appendChild(empty);
  }

  // Host vs guest controls
  if (room.host === myId) {
    showEl('hostControls');
    hideEl('guestWait');
    document.getElementById('startBtn').disabled = ids.length < 2;
    document.getElementById('startBtn').textContent = ids.length < 2 ? 'â³ Esperando jugadores...' : 'ğŸƒ Empezar Partida';
  } else {
    hideEl('hostControls');
    showEl('guestWait');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HOST: START GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function hostStartGame() {
  if (!isHost || !db) return;
  const players = currentRoom.players || {};
  const ids = Object.keys(players);
  if (ids.length < 2) { toast('Necesitas al menos 2 jugadores'); return; }

  // Deal cards: each player gets 2 initial + 5 extras (hit pool) + dealer gets 2+3
  const deck = buildShuffledDeck(4);
  let di = 0;
  const pop = () => deck[di++];

  // Turn order (random)
  const shuffledIds = [...ids].sort(() => Math.random() - 0.5);

  const updates = {};
  updates[`${GAME_PATH}/${roomCode}/status`] = 'betting';
  updates[`${GAME_PATH}/${roomCode}/round`] = (currentRoom.round || 0) + 1;
  updates[`${GAME_PATH}/${roomCode}/turnOrder`] = shuffledIds;
  updates[`${GAME_PATH}/${roomCode}/currentTurn`] = null;
  updates[`${GAME_PATH}/${roomCode}/dealerRevealed`] = false;
  updates[`${GAME_PATH}/${roomCode}/dealerHand`] = [];

  // Pre-deal card pools for each player (2 initial + 8 extras)
  shuffledIds.forEach(pid => {
    const pool = [];
    for (let i = 0; i < 10; i++) pool.push(pop());
    updates[`${GAME_PATH}/${roomCode}/players/${pid}/cardPool`] = pool;
    updates[`${GAME_PATH}/${roomCode}/players/${pid}/hand`] = [];
    updates[`${GAME_PATH}/${roomCode}/players/${pid}/cardIdx`] = 0;
    updates[`${GAME_PATH}/${roomCode}/players/${pid}/bet`] = 0;
    updates[`${GAME_PATH}/${roomCode}/players/${pid}/status`] = 'betting';
    updates[`${GAME_PATH}/${roomCode}/players/${pid}/result`] = null;
    updates[`${GAME_PATH}/${roomCode}/players/${pid}/payout`] = 0;
  });

  // Dealer pool (2 initial shown + 1 hidden initially + 5 extras)
  const dealerPool = [];
  for (let i = 0; i < 8; i++) dealerPool.push(pop());
  updates[`${GAME_PATH}/${roomCode}/dealerPool`] = dealerPool;
  updates[`${GAME_PATH}/${roomCode}/dealerIdx`] = 0;

  await db.ref('/').update(updates);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BETTING PHASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBetting(room) {
  // Ensure game screen is showing
  const gameEl = document.getElementById('scGame');
  gameEl.classList.remove('hidden');
  gameEl.style.display = 'flex';
  gameEl.style.flexDirection = 'column';
  document.getElementById('gameCode').textContent = roomCode;
  document.getElementById('myName2').textContent = myName;
  document.getElementById('myBalance').textContent = '$' + myBal.toLocaleString();
  // Hide stats bar and solo exit (multiplayer mode)
  document.getElementById('statsBar').style.display = 'none';
  hideEl('soloExitBtn');

  setStatusBadge('betting', 'ğŸ’° Apuestas');
  renderOpponents(room, null);
  renderDealerCards([], false);
  document.getElementById('dealerScore').textContent = '';
  hideEl('resultsOverlay');
  hideEl('playActions');
  hideEl('waitMsg');
  document.getElementById('msgBanner').textContent = '';
  hideEl('myLiveScore');
  // Clear bet chip at start of betting
  document.getElementById('myBetChip').style.display = 'none';

  const me = room.players?.[myId];
  clearMyCards(); // also resets splitFp

  if (!me) {
    // Player not yet in room data â€” show loading
    showWaitMsg('â³ Cargando partida...');
    hideEl('betPanel');
    return;
  }

  if (me?.status === 'betting') {
    showEl('betPanel');
    document.getElementById('myBetDisplay').textContent = myBet;
    hideEl('hostGameCtrl');
    hideEl('guestGameCtrl');
  } else {
    hideEl('betPanel');
    const players = room.players || {};
    const total = Object.keys(players).length;
    const ready = Object.values(players).filter(p => p.status === 'bet_ready').length;
    showWaitMsg(`âœ… Apuesta confirmada â€” ${ready}/${total} jugadores listos...`);
    if (room.host === myId) showEl('hostGameCtrl'); else showEl('guestGameCtrl');
  }

  // Host: trigger deal when all bets are in
  if (isHost) {
    const players2 = room.players || {};
    const ids2 = Object.keys(players2);
    const readyCount = ids2.filter(pid => players2[pid]?.status === 'bet_ready').length;
    const totalCount = ids2.length;
    if (readyCount === totalCount && totalCount >= 2) {
      checkAllBet(room);
    }
  }
}

function addBet(amt) {
  if (myBal - myBet < amt) { toast('âš ï¸ Saldo insuficiente'); return; }
  myBet += amt;
  document.getElementById('myBetDisplay').textContent = myBet;
  sfxChip();
}
function clearBet() { myBet = 0; document.getElementById('myBetDisplay').textContent = 0; }

async function confirmBet() {
  if (soloMode) { soloConfirmBet(); return; }
  if (myBet < 1) { toast('âš ï¸ Coloca al menos $1'); return; }
  if (!db) return;
  await db.ref(`${GAME_PATH}/${roomCode}/players/${myId}`).update({ bet: myBet, status: 'bet_ready' });
  hideEl('betPanel');
  showWaitMsg('âœ… Apuesta de $' + myBet + ' confirmada. Esperando a los demÃ¡s...');
  // El host detecta automÃ¡ticamente via el listener cuando todos apuesten
}

function checkAllBet(room) {
  if (!isHost) return;
  const players = room?.players || {};
  const ids = Object.keys(players);
  if (ids.length < 2) return;
  const allReady = ids.every(pid => {
    const s = players[pid]?.status;
    return s === 'bet_ready';
  });
  if (allReady) {
    toast('ğŸƒ Â¡Todos apostaron! Repartiendo cartas...', 2000);
    setTimeout(hostDealCards, 1000);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HOST: DEAL INITIAL CARDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function hostDealCards() {
  if (!isHost || !db) return;
  try {
    // Fetch fresh snapshot â€” never trust stale currentRoom
    const snap = await db.ref(`${GAME_PATH}/${roomCode}`).once('value');
    const room = snap.val();
    if (!room) { toast('âŒ Error: sala no encontrada'); return; }
    if (room.status !== 'betting') return; // already dealt, ignore

    const turnOrder = room.turnOrder || [];
    if (turnOrder.length === 0) { toast('âŒ Error: sin orden de turnos'); return; }

    const updates = {};

    turnOrder.forEach(pid => {
      const p = room.players?.[pid];
      if (!p) return;
      // Firebase returns arrays as objects with numeric keys â€” convert back
      const poolRaw = p.cardPool || {};
      const pool = Array.isArray(poolRaw) ? poolRaw : Object.values(poolRaw);
      const hand = [pool[0], pool[1]].filter(Boolean);
      if (hand.length < 2) { console.error('Pool vacÃ­o para', pid, pool); return; }
      const status = handTotal(hand) === 21 ? 'blackjack' : 'waiting_turn';
      updates[`${GAME_PATH}/${roomCode}/players/${pid}/hand`] = hand;
      updates[`${GAME_PATH}/${roomCode}/players/${pid}/cardIdx`] = 2;
      updates[`${GAME_PATH}/${roomCode}/players/${pid}/status`] = status;
    });

    const dPoolRaw = room.dealerPool || {};
    const dPool = Array.isArray(dPoolRaw) ? dPoolRaw : Object.values(dPoolRaw);
    if (dPool.length < 2) { toast('âŒ Error: pool del dealer vacÃ­o'); return; }

    updates[`${GAME_PATH}/${roomCode}/dealerHand`] = [dPool[0], dPool[1]];
    updates[`${GAME_PATH}/${roomCode}/dealerIdx`] = 2;
    updates[`${GAME_PATH}/${roomCode}/status`] = 'playing';
    updates[`${GAME_PATH}/${roomCode}/currentTurn`] = turnOrder[0];

    await db.ref('/').update(updates);
  } catch(e) {
    toast('âŒ Error repartiendo: ' + e.message, 5000);
    console.error('hostDealCards error:', e);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAYING PHASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPlaying(room) {
  hide('scWaiting');
  show('scGame');
  document.getElementById('scGame').style.display = 'flex';
  document.getElementById('scGame').style.flexDirection = 'column';
  document.getElementById('gameCode').textContent = roomCode;
  document.getElementById('myBalance').textContent = '$' + myBal.toLocaleString();

  const currentTurn = room.currentTurn;
  setStatusBadge('playing', 'ğŸƒ Jugando');
  renderDealerCards(room.dealerHand || [], false);
  renderOpponents(room, currentTurn);

  const me = room.players?.[myId];
  if (!me) return;
  hideEl('betPanel');
  hideEl('resultsOverlay');

  // Show my bet as chip
  const myBetChip = document.getElementById('myBetChip');
  if (me.bet > 0) {
    myBetChip.innerHTML = '';
    myBetChip.appendChild(makeChipStack(me.splitBet ? me.bet * 2 : me.bet));
    myBetChip.style.display = '';
  } else {
    myBetChip.style.display = 'none';
  }

  // Render my cards â€” split mode or normal
  if (me.playingHand) {
    renderSplitHands(me);
    updateMyLiveScore(toArr(me.hand), me.status);
  } else {
    renderMyCards(toArr(me.hand));
    updateMyLiveScore(toArr(me.hand), me.status);
  }

  const isMyTurn = currentTurn === myId;
  const myStatus = me.status;

  if (isMyTurn && (myStatus === 'waiting_turn' || myStatus === 'playing')) {
    showEl('playActions', 'flex');
    hideEl('waitMsg');
    const myHand = toArr(me.hand);
    // No double after split, no double if more than 2 cards
    document.getElementById('btnDouble').disabled = myHand.length !== 2 || myBal < me.bet || !!me.playingHand;
    // Split: only when 2 same-rank cards, no existing split
    const canSplit = myHand.length === 2 && myHand[0]?.r === myHand[1]?.r && myBal >= me.bet && !me.playingHand;
    document.getElementById('btnSplit').style.display = canSplit ? '' : 'none';
    document.getElementById('msgBanner').textContent = me.playingHand ? (me.playingHand === 1 ? 'âœ‚ï¸ Mano 1 â€” Juega' : 'âœ‚ï¸ Mano 2 â€” Juega') : '';
    document.getElementById('msgBanner').className = 'msg-banner mb-push';
    if (room.host === myId) showEl('hostGameCtrl'); else showEl('guestGameCtrl');
    if (myStatus === 'waiting_turn') db.ref(`${GAME_PATH}/${roomCode}/players/${myId}/status`).set('playing');
  } else if (myStatus === 'bust') {
    hideEl('playActions');
    showWaitMsg('ğŸ’¥ Bust â€” esperando otros jugadores...');
    setBannerMsg('ğŸ’¥ Â¡Te pasaste!', 'mb-lose');
    if (room.host === myId) showEl('hostGameCtrl'); else showEl('guestGameCtrl');
  } else if (myStatus === 'stand' || myStatus === 'blackjack') {
    hideEl('playActions');
    showWaitMsg(myStatus === 'blackjack' ? 'ğŸƒ Â¡Blackjack! Esperando...' : 'âœ‹ Plantado â€” esperando otros...');
    if (room.host === myId) showEl('hostGameCtrl'); else showEl('guestGameCtrl');
  } else {
    hideEl('playActions');
    showWaitMsg(`â³ Turno de ${room.players?.[currentTurn]?.name || '...'}...`);
    if (room.host === myId) showEl('hostGameCtrl'); else showEl('guestGameCtrl');
  }
}

// Renders two split hands side by side
function renderSplitHands(me) {
  const el = document.getElementById('myCards');
  // hand1: stored in splitHand1 when playing hand2, otherwise in hand (when playing hand1)
  const hand1 = me.playingHand === 1 ? toArr(me.hand) : toArr(me.splitHand1 || []);
  const hand2 = me.playingHand === 1 ? toArr(me.hand2 || []) : toArr(me.hand);
  const ph = me.playingHand;

  // Build unique fingerprint to detect actual changes
  const fp = ph + '|' + hand1.map(c=>c.r+c.s).join(',') + '|' + hand2.map(c=>c.r+c.s).join(',');
  if (el.dataset.splitFp === fp) return; // no change, skip
  el.dataset.splitFp = fp;
  el.dataset.cardCount = '99'; // block normal renderMyCards
  el.innerHTML = '';

  const makePanel = (cards, active, label) => {
    const panel = document.createElement('div');
    panel.style.cssText = `flex:1;border:2px solid ${active ? 'rgba(255,215,0,.6)' : 'rgba(255,255,255,.07)'};border-radius:12px;padding:7px;min-height:90px;opacity:${active ? '1' : '.5'};transition:opacity .3s;`;
    const lbl = document.createElement('div');
    lbl.style.cssText = 'font-size:8px;letter-spacing:2px;color:rgba(255,255,255,.35);text-transform:uppercase;margin-bottom:5px;display:flex;justify-content:space-between;';
    const t = handTotal(cards);
    lbl.innerHTML = `<span>${label}${active ? ' â–¶' : ''}</span><span style="color:${t>21?'#e74c3c':t===21?'#f0d060':'rgba(255,255,255,.5)'}">${cards.length>0?t:''}</span>`;
    panel.appendChild(lbl);
    const row = document.createElement('div');
    row.style.cssText = 'display:flex;gap:4px;flex-wrap:wrap;align-items:flex-start;min-height:68px;';
    cards.forEach((c, i) => {
      if (!c) return;
      const card = makeCardEl(c);
      // Last card of active hand gets hit-anim if it's a third card (hit after split)
      if (active && i >= 2) card.classList.add('card-sideways');
      else card.classList.add('deal-anim');
      card.style.animationDelay = (i * 0.1) + 's';
      row.appendChild(card);
    });
    panel.appendChild(row);
    return panel;
  };

  const container = document.createElement('div');
  container.style.cssText = 'display:flex;gap:8px;width:100%;';
  container.appendChild(makePanel(hand1, ph === 1, 'Mano 1'));
  container.appendChild(makePanel(hand2, ph === 2, 'Mano 2'));
  el.appendChild(container);
}

async function playerHit() {
  if (soloMode) { soloHit(); return; }
  if (!db) return;
  const me = currentRoom?.players?.[myId];
  if (!me) return;
  const pool = Array.isArray(me.cardPool) ? me.cardPool : Object.values(me.cardPool || {});
  const hand = Array.isArray(me.hand) ? me.hand : Object.values(me.hand || {});
  const idx = me.cardIdx || 2;
  if (idx >= pool.length) { toast('âš ï¸ Sin mÃ¡s cartas disponibles'); return; }

  const newCard = pool[idx];
  const newHand = [...hand, newCard];
  const newTotal = handTotal(newHand);
  const newIdx = idx + 1;

  const updates = {};
  updates[`${GAME_PATH}/${roomCode}/players/${myId}/hand`] = newHand;
  updates[`${GAME_PATH}/${roomCode}/players/${myId}/cardIdx`] = newIdx;

  const onSplitHand1 = me.playingHand === 1 && me.hand2;

  if (newTotal > 21) {
    if (onSplitHand1) {
      // Bust on hand1 â†’ switch to hand2
      updates[`${GAME_PATH}/${roomCode}/players/${myId}/splitHand1`] = newHand;
      updates[`${GAME_PATH}/${roomCode}/players/${myId}/hand`] = toArr(me.hand2);
      updates[`${GAME_PATH}/${roomCode}/players/${myId}/hand2`] = null;
      updates[`${GAME_PATH}/${roomCode}/players/${myId}/playingHand`] = 2;
      updates[`${GAME_PATH}/${roomCode}/players/${myId}/status`] = 'playing';
      await db.ref('/').update(updates);
    } else {
      updates[`${GAME_PATH}/${roomCode}/players/${myId}/status`] = 'bust';
      await db.ref('/').update(updates);
      if (isHost) setTimeout(() => advanceTurn(), 600);
    }
  } else if (newTotal === 21) {
    if (onSplitHand1) {
      // 21 on hand1 â†’ auto-stand and switch to hand2
      updates[`${GAME_PATH}/${roomCode}/players/${myId}/splitHand1`] = newHand;
      updates[`${GAME_PATH}/${roomCode}/players/${myId}/hand`] = toArr(me.hand2);
      updates[`${GAME_PATH}/${roomCode}/players/${myId}/hand2`] = null;
      updates[`${GAME_PATH}/${roomCode}/players/${myId}/playingHand`] = 2;
      updates[`${GAME_PATH}/${roomCode}/players/${myId}/status`] = 'playing';
      await db.ref('/').update(updates);
    } else {
      updates[`${GAME_PATH}/${roomCode}/players/${myId}/status`] = 'stand';
      await db.ref('/').update(updates);
      if (isHost) setTimeout(() => advanceTurn(), 600);
    }
  } else {
    await db.ref('/').update(updates);
  }
}

async function playerStand() {
  if (soloMode) { soloStand(); return; }
  if (!db) return;
  const me = currentRoom?.players?.[myId];

  // Split hand1 done â†’ switch to hand2 instead of advancing turn
  if (me?.playingHand === 1 && me?.hand2) {
    const h2 = toArr(me.hand2);
    await db.ref(`${GAME_PATH}/${roomCode}/players/${myId}`).update({
      splitHand1: toArr(me.hand),
      hand: h2,
      hand2: null,
      playingHand: 2,
      status: 'playing'
    });
    return;
  }

  await db.ref(`${GAME_PATH}/${roomCode}/players/${myId}/status`).set('stand');
  if (isHost) setTimeout(advanceTurn, 400);
}

async function playerDouble() {
  if (soloMode) { soloDouble(); return; }
  if (!db) return;
  const me = currentRoom?.players?.[myId];
  if (!me || myBal < me.bet || me.playingHand) return; // no double after split
  myBal -= me.bet;
  const newBet = me.bet * 2;
  saveLocal();

  const pool = Array.isArray(me.cardPool) ? me.cardPool : Object.values(me.cardPool || {});
  const idx = me.cardIdx || 2;
  const newCard = pool[idx];
  const newHand = [...toArr(me.hand), newCard];
  const total = handTotal(newHand);
  const status = total > 21 ? 'bust' : 'stand';

  await db.ref(`${GAME_PATH}/${roomCode}/players/${myId}`).update({
    hand: newHand, cardIdx: idx+1, bet: newBet, status
  });
  if (isHost) setTimeout(() => advanceTurn(), 600);
}

// â”€â”€ SPLIT â”€â”€
async function playerSplit() {
  if (soloMode) { soloSplit(); return; }
  if (!db) return;
  const me = currentRoom?.players?.[myId];
  if (!me || myBal < me.bet) { toast('âš ï¸ Saldo insuficiente para dividir'); return; }
  const hand = toArr(me.hand);
  if (hand.length !== 2 || hand[0]?.r !== hand[1]?.r) { toast('âš ï¸ Solo puedes dividir con dos cartas iguales'); return; }

  myBal -= me.bet; // second hand costs same as first
  saveLocal();

  const pool = Array.isArray(me.cardPool) ? me.cardPool : Object.values(me.cardPool || {});
  const idx = me.cardIdx || 2;
  // Each split hand gets its own second card from pool
  const hand1 = [hand[0], pool[idx]];
  const hand2 = [hand[1], pool[idx + 1]];
  const newIdx = idx + 2;

  // Clear split fingerprint so renderSplitHands re-renders
  const el = document.getElementById('myCards');
  el.dataset.splitFp = '';
  el.dataset.cardCount = '99';

  await db.ref(`${GAME_PATH}/${roomCode}/players/${myId}`).update({
    hand: hand1,
    hand2: hand2,
    splitHand1: null,
    cardIdx: newIdx,
    status: 'playing',
    splitBet: me.bet,
    playingHand: 1
  });

  toast('âœ‚ï¸ Dividido â€” juega la mano 1', 2000);
  document.getElementById('btnSplit').style.display = 'none';
}

// â”€â”€ ADVANCE TURN (host only) â”€â”€
async function advanceTurn() {
  if (!isHost || !db) return;
  const snap = await db.ref(`${GAME_PATH}/${roomCode}`).once('value');
  const room = snap.val();
  if (!room || room.status !== 'playing') return;

  // toArr handles Firebase returning arrays as objects
  const order = toArr(room.turnOrder);
  const current = room.currentTurn;
  const players = room.players || {};

  // GUARD: if current player is still active, don't advance yet
  if (current) {
    const cs = players[current]?.status || '';
    if (cs === 'playing' || cs === 'waiting_turn') {
      console.log('advanceTurn: current player still active, aborting');
      return;
    }
  }

  const currentIdx = current ? order.indexOf(current) : -1;
  let nextIdx = currentIdx + 1;
  while (nextIdx < order.length) {
    const pid = order[nextIdx];
    const s = players[pid]?.status || '';
    if (s === 'waiting_turn') break; // only advance to players who haven't played
    nextIdx++;
  }

  if (nextIdx >= order.length) {
    await db.ref(`${GAME_PATH}/${roomCode}`).update({ status: 'dealer', currentTurn: null });
    setTimeout(() => hostRunDealer(), 800);
  } else {
    const nextPid = order[nextIdx];
    await db.ref(`${GAME_PATH}/${roomCode}/currentTurn`).set(nextPid);
    // Auto-skip blackjacks
    if (players[nextPid]?.status === 'blackjack') {
      setTimeout(() => advanceTurn(), 500);
    }
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEALER TURN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDealerTurn(room) {
  setStatusBadge('dealer', 'ğŸ¦ Dealer juega');
  renderDealerCards(room.dealerHand || [], room.dealerRevealed || false);
  renderOpponents(room, null);
  const me = room.players?.[myId];
  if (me) {
    renderMyCards(toArr(me.hand));
    updateMyLiveScore(toArr(me.hand), me.status);
  }
  hideEl('betPanel'); hideEl('playActions');
  showWaitMsg('ğŸ¦ El dealer estÃ¡ jugando...');
  if (room.host === myId) showEl('hostGameCtrl'); else showEl('guestGameCtrl');
  if (isHost && !room.dealerRevealed) setTimeout(() => hostRunDealer(), 500);
}

async function hostRunDealer() {
  if (!isHost || !db) return;
  const room = currentRoom;
  if (!room || room.status !== 'dealer') return;

  let dealerHand = [...(room.dealerHand || [])];
  let dIdx = room.dealerIdx || 2;
  const dPool = room.dealerPool || [];

  // Reveal hole card
  await db.ref(`${GAME_PATH}/${roomCode}/dealerRevealed`).set(true);
  await new Promise(r => setTimeout(r, 800));

  // Dealer hits until 17+
  while (handTotal(dealerHand) < 17 && dIdx < dPool.length) {
    dealerHand.push(dPool[dIdx++]);
    await db.ref(`${GAME_PATH}/${roomCode}`).update({ dealerHand, dealerIdx: dIdx });
    await new Promise(r => setTimeout(r, 800));
  }

  // Calculate results
  const dealerTotal = handTotal(dealerHand);
  const dealerBJ = dealerTotal === 21 && dealerHand.length === 2;
  const players = room.players || {};
  const updates = {};

  function scoreHand(hand, bet) {
    const h = toArr(hand);
    const total = handTotal(h);
    const bj = total === 21 && h.length === 2;
    const bust = total > 21;
    let result, payout;
    if (bust) { result = 'lose'; payout = 0; }
    else if (bj && !dealerBJ) { result = 'blackjack'; payout = Math.floor(bet * 2.5); }
    else if (dealerBJ && !bj) { result = 'lose'; payout = 0; }
    else if (dealerTotal > 21) { result = 'win'; payout = bet * 2; }
    else if (total > dealerTotal) { result = 'win'; payout = bet * 2; }
    else if (total === dealerTotal) { result = 'push'; payout = bet; }
    else { result = 'lose'; payout = 0; }
    return { result, payout };
  }

  Object.entries(players).forEach(([pid, p]) => {
    const bet = p.bet || 0;

    // Score main hand
    const main = scoreHand(p.hand, bet);
    let totalPayout = main.payout;

    // Score split hand1 if it exists
    let splitResult = null;
    if (p.splitHand1) {
      const s1 = scoreHand(p.splitHand1, p.splitBet || bet);
      totalPayout += s1.payout;
      splitResult = s1.result;
      updates[`${GAME_PATH}/${roomCode}/players/${pid}/splitResult`] = splitResult;
      updates[`${GAME_PATH}/${roomCode}/players/${pid}/splitPayout`] = s1.payout;
    }

    updates[`${GAME_PATH}/${roomCode}/players/${pid}/result`] = main.result;
    updates[`${GAME_PATH}/${roomCode}/players/${pid}/payout`] = totalPayout;
    updates[`${GAME_PATH}/${roomCode}/players/${pid}/status`] = 'done';

    // Update balance â€” reset to INIT_BAL if bankrupt
    const prevBal = p.bal || INIT_BAL;
    const totalBet = bet + (p.splitBet || 0);
    let newBal = prevBal - totalBet + totalPayout;
    if (newBal <= 0) newBal = INIT_BAL; // bankruptcy: free reload
    updates[`${GAME_PATH}/${roomCode}/players/${pid}/bal`] = newBal;
  });

  updates[`${GAME_PATH}/${roomCode}/status`] = 'results';
  updates[`${GAME_PATH}/${roomCode}/dealerHand`] = dealerHand;
  updates[`${GAME_PATH}/${roomCode}/dealerIdx`] = dIdx;
  await db.ref('/').update(updates);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderResults(room) {
  setStatusBadge('results', 'ğŸ† Resultados');
  renderDealerCards(room.dealerHand || [], true);
  const dt = handTotal(room.dealerHand || []);
  document.getElementById('dealerScore').textContent = `Dealer: ${dt}${dt>21?' â€” BUST':''}`;
  renderOpponents(room, null);

  const me = room.players?.[myId];
  if (me) {
    if (me.status === 'done' && me.result) {
      const prevBal = myBal;
      myBal = me.bal || myBal;
      // Show bankruptcy message if reloaded
      if (prevBal > 0 && me.bal === INIT_BAL && prevBal !== INIT_BAL) {
        setTimeout(() => toast('ğŸ’¸ Â¡Sin fondos! Recarga gratuita de $1,000 aplicada ğŸ', 4000), 500);
      }
      document.getElementById('myBalance').textContent = '$' + myBal.toLocaleString();
      saveLocal();
    }
    // If split, show split hands; else normal
    if (me.splitHand1) {
      renderSplitHands({ hand: me.hand, hand2: null, splitHand1: me.splitHand1, playingHand: 2 });
    } else {
      renderMyCards(toArr(me.hand));
    }
    updateMyLiveScore(toArr(me.hand), me.status);

    const result = me.result;
    const payout = me.payout || 0;
    const bet = me.bet || 0;
    const totalBet = bet + (me.splitBet || 0);
    const profit = payout - totalBet;

    if (me.splitHand1) {
      // Split result banner
      const r1 = me.splitResult || 'lose';
      const r2 = result;
      const fmtR = r => (r==='win'||r==='blackjack') ? 'âœ… GanÃ³' : r==='push' ? 'ğŸ¤ Push' : 'âŒ PerdiÃ³';
      setBannerMsg('âœ‚ï¸ M1: ' + fmtR(me.splitResult||'lose') + ' Â· M2: ' + fmtR(result) + ' Â· ' + (profit>=0?'+':'') + '$' + profit, profit>=0?'mb-win':'mb-lose');
    } else if (result === 'blackjack') { setBannerMsg('ğŸƒ Â¡BLACKJACK! +$' + (payout-bet), 'mb-win'); bigBurst(); }
    else if (result === 'win') { setBannerMsg('ğŸ‰ Â¡Ganaste! +$' + profit, 'mb-win'); burst(window.innerWidth/2, 280, 22); }
    else if (result === 'push') { setBannerMsg('ğŸ¤ Empate â€” Apuesta devuelta', 'mb-push'); }
    else { setBannerMsg('âŒ Perdiste $' + bet, 'mb-lose'); }
  }

  hideEl('betPanel'); hideEl('playActions'); hideEl('waitMsg');

  // Results overlay - show with animation
  const overlay = document.getElementById('resultsOverlay');
  overlay.style.cssText = 'display:flex;flex-direction:column;align-items:center;justify-content:flex-start;position:absolute;inset:0;background:rgba(0,0,0,.92);z-index:200;padding:20px 16px 30px;overflow-y:auto;animation:jpIn .35s ease;';

  const players = room.players || {};
  const order = room.turnOrder || Object.keys(players);
  const list = document.getElementById('resultsList');
  list.innerHTML = '';

  const dealerTotal = handTotal(toArr(room.dealerHand));

  // Add dealer row first
  const dealerRow = document.createElement('div');
  dealerRow.className = 'result-row';
  dealerRow.style.cssText = 'background:rgba(201,168,76,.06);border:1px solid rgba(201,168,76,.15);margin-bottom:4px;';
  dealerRow.innerHTML = `<div style="width:30px;height:30px;border-radius:50%;background:#444;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;">ğŸ¦</div>
    <div style="flex:1;padding-left:4px"><div class="rr-name">Dealer</div><div class="rr-hand">Mano: ${dealerTotal}${dealerTotal>21?' â€” BUST':''}</div></div>`;
  list.appendChild(dealerRow);

  order.forEach((pid, idx) => {
    const p = players[pid];
    if (!p) return;
    const hand = toArr(p.hand);
    const total = handTotal(hand);
    const result = p.result || 'lose';
    const bet = p.bet || 0;
    const payout = p.payout || 0;
    const profit = payout - bet;

    const row = document.createElement('div');
    row.className = 'result-row';
    row.style.animation = `slideIn .3s ease ${idx * 0.1}s both`;
    if (pid === myId) row.style.border = '1px solid rgba(201,168,76,.4)';
    if (result === 'win' || result === 'blackjack') row.style.background = 'rgba(46,204,113,.06)';
    if (result === 'lose') row.style.background = 'rgba(231,76,60,.04)';

    const av = makeAvatar(p.name, p.color, 30);
    const info = document.createElement('div'); info.style.flex = '1';
    const nm = document.createElement('div'); nm.className = 'rr-name';
    nm.textContent = p.name + (pid===myId?' ğŸ‘¤':'');
    const hd = document.createElement('div'); hd.className = 'rr-hand';
    hd.textContent = `${total}${total>21?' BUST':''} Â· apostÃ³ $${bet}`;
    info.appendChild(nm); info.appendChild(hd);

    const res = document.createElement('div'); res.style.textAlign = 'right';
    const rv = document.createElement('div');
    if (result === 'blackjack') { rv.className = 'rr-result rr-bj'; rv.textContent = 'ğŸƒ BLACKJACK'; }
    else if (result === 'win')   { rv.className = 'rr-result rr-win'; rv.textContent = 'âœ… GANÃ“'; }
    else if (result === 'push')  { rv.className = 'rr-result rr-push'; rv.textContent = 'ğŸ¤ EMPATE'; }
    else                         { rv.className = 'rr-result rr-lose'; rv.textContent = 'âŒ PERDIÃ“'; }
    const py = document.createElement('div'); py.className = 'rr-payout';
    py.style.fontSize = '13px'; py.style.fontWeight = 'bold';
    py.textContent = (profit >= 0 ? '+' : '') + '$' + profit;
    py.style.color = profit > 0 ? '#2ecc71' : profit < 0 ? '#e74c3c' : 'var(--gold)';
    res.appendChild(rv); res.appendChild(py);
    row.appendChild(av); row.appendChild(info); row.appendChild(res);
    list.appendChild(row);
  });

  // Always show correct next-round button
  hideEl('soloNextBtn');

  // Track multiplayer stats for my result
  const me2 = room.players?.[myId];
  if (me2?.result) {
    const myResult = me2.result;
    const myBet2 = me2.bet || 0;
    const myPayout = me2.payout || 0;
    mpStats.handsPlayed++;
    mpStats.totalProfit += (myPayout - myBet2);
    if (myResult === 'win' || myResult === 'blackjack') {
      mpStats.wins++;
      mpStats.streak = Math.max(0, mpStats.streak) + 1;
      mpStats.bestStreak = Math.max(mpStats.bestStreak, mpStats.streak);
      if (myResult === 'blackjack') mpStats.blackjacks++;
      myResult === 'blackjack' ? sfxBlackjack() : sfxWin();
    } else if (myResult === 'push') {
      mpStats.pushes++;
      mpStats.streak = 0;
    } else {
      mpStats.losses++;
      mpStats.streak = Math.min(0, mpStats.streak) - 1;
      sfxLose();
    }
    saveMpStats();
  }

  // Show mp stats mini bar
  const wr = mpStats.handsPlayed > 0 ? Math.round(mpStats.wins * 100 / mpStats.handsPlayed) : 0;
  const mpStatsHtml = `
    <div style="display:flex;gap:6px;justify-content:center;flex-wrap:wrap;width:100%;max-width:320px;margin:10px 0 4px;">
      <div class="stat-pill"><span class="stat-lbl">Manos</span><span class="stat-val">${mpStats.handsPlayed}</span></div>
      <div class="stat-pill"><span class="stat-lbl">Win%</span><span class="stat-val" style="color:${wr>=50?'#2ecc71':'#e74c3c'}">${wr}%</span></div>
      <div class="stat-pill"><span class="stat-lbl">Racha</span><span class="stat-val">${mpStats.streak>0?'ğŸ”¥':'â„ï¸'} ${mpStats.streak}</span></div>
      <div class="stat-pill"><span class="stat-lbl">BJ</span><span class="stat-val" style="color:#f0d060">âš¡${mpStats.blackjacks}</span></div>
      <div class="stat-pill"><span class="stat-lbl">P/L</span><span class="stat-val" style="color:${mpStats.totalProfit>=0?'#2ecc71':'#e74c3c'}">${mpStats.totalProfit>=0?'+':''}$${mpStats.totalProfit}</span></div>
    </div>`;
  const statsDiv = document.createElement('div');
  statsDiv.innerHTML = mpStatsHtml;
  list.appendChild(statsDiv.firstElementChild);

  if (isHost) {
    document.getElementById('hostNextBtn').style.display = 'block';
    document.getElementById('guestNextMsg').style.display = 'none';
    hideEl('hostGameCtrl');
  } else {
    document.getElementById('hostNextBtn').style.display = 'none';
    document.getElementById('guestNextMsg').style.display = 'block';
    hideEl('guestGameCtrl');
  }

  // Apply glow to my cards based on result
  const myResult = room.players?.[myId]?.result;
  setTimeout(() => {
    document.querySelectorAll('#myCards .card').forEach(c => {
      if (myResult === 'win') c.classList.add('win-glow');
      else if (myResult === 'blackjack') c.classList.add('bj-glow');
      else if (myResult === 'lose') c.classList.add('bust-glow');
    });
  }, 300);
}

async function hostNextRound() {
  if (!isHost || !db) return;
  document.getElementById('resultsOverlay').style.display = 'none';

  // Skip lobby â€” go straight to betting with fresh cards pre-dealt
  const snap = await db.ref(`${GAME_PATH}/${roomCode}`).once('value');
  const room = snap.val();
  if (!room) return;

  const players = room.players || {};
  const ids = Object.keys(players);
  if (ids.length < 2) { toast('âŒ Necesitas al menos 2 jugadores'); return; }

  const deck = buildShuffledDeck(4);
  let di = 0;
  const pop = () => deck[di++];
  const shuffledIds = [...ids].sort(() => Math.random() - 0.5);

  const updates = {};
  updates[`${GAME_PATH}/${roomCode}/status`] = 'betting';
  updates[`${GAME_PATH}/${roomCode}/round`] = (room.round || 0) + 1;
  updates[`${GAME_PATH}/${roomCode}/turnOrder`] = shuffledIds;
  updates[`${GAME_PATH}/${roomCode}/currentTurn`] = null;
  updates[`${GAME_PATH}/${roomCode}/dealerRevealed`] = false;
  updates[`${GAME_PATH}/${roomCode}/dealerHand`] = [];

  shuffledIds.forEach(pid => {
    const pool = [];
    for (let i = 0; i < 10; i++) pool.push(pop());
    updates[`${GAME_PATH}/${roomCode}/players/${pid}/cardPool`] = pool;
    updates[`${GAME_PATH}/${roomCode}/players/${pid}/hand`] = [];
    updates[`${GAME_PATH}/${roomCode}/players/${pid}/hand2`] = null;
    updates[`${GAME_PATH}/${roomCode}/players/${pid}/splitHand1`] = null;
    updates[`${GAME_PATH}/${roomCode}/players/${pid}/splitBet`] = 0;
    updates[`${GAME_PATH}/${roomCode}/players/${pid}/splitResult`] = null;
    updates[`${GAME_PATH}/${roomCode}/players/${pid}/splitPayout`] = 0;
    updates[`${GAME_PATH}/${roomCode}/players/${pid}/playingHand`] = 0;
    updates[`${GAME_PATH}/${roomCode}/players/${pid}/cardIdx`] = 0;
    updates[`${GAME_PATH}/${roomCode}/players/${pid}/bet`] = 0;
    updates[`${GAME_PATH}/${roomCode}/players/${pid}/status`] = 'betting';
    updates[`${GAME_PATH}/${roomCode}/players/${pid}/result`] = null;
    updates[`${GAME_PATH}/${roomCode}/players/${pid}/payout`] = 0;
    updates[`${GAME_PATH}/${roomCode}/players/${pid}/actionRequest`] = null;
    // Sync balance back
    const bal = players[pid]?.bal;
    if (bal !== undefined) updates[`${GAME_PATH}/${roomCode}/players/${pid}/bal`] = bal;
  });

  const dealerPool = [];
  for (let i = 0; i < 8; i++) dealerPool.push(pop());
  updates[`${GAME_PATH}/${roomCode}/dealerPool`] = dealerPool;
  updates[`${GAME_PATH}/${roomCode}/dealerIdx`] = 0;

  myBet = 0;
  await db.ref('/').update(updates);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€â”€ CHIP STACK VISUAL â”€â”€â”€
function makeChipStack(amount, size='md') {
  const wrap = document.createElement('div');
  wrap.style.cssText = 'display:inline-flex;align-items:center;gap:4px;';

  // Pick chip color based on value
  const chipColor = amount >= 100 ? '#f0d060' : amount >= 50 ? '#9b59b6' : amount >= 25 ? '#2ecc71' : amount >= 10 ? '#3498db' : '#e74c3c';
  const chipSize = size === 'sm' ? 20 : 26;
  const fontSize = size === 'sm' ? 8 : 10;

  const chip = document.createElement('div');
  chip.style.cssText = `width:${chipSize}px;height:${chipSize}px;border-radius:50%;background:${chipColor};border:2px solid rgba(255,255,255,.3);display:flex;align-items:center;justify-content:center;font-size:${fontSize}px;font-weight:bold;color:#000;box-shadow:0 2px 6px rgba(0,0,0,.5),inset 0 1px 0 rgba(255,255,255,.4);flex-shrink:0;`;
  chip.textContent = amount >= 100 ? 'ğŸ’°' : '$';

  const label = document.createElement('span');
  label.style.cssText = `font-size:${fontSize + 2}px;font-weight:bold;color:${chipColor};text-shadow:0 1px 3px rgba(0,0,0,.8);`;
  label.textContent = '$' + amount;

  wrap.appendChild(chip);
  wrap.appendChild(label);
  return wrap;
}

function makeCardEl(card, faceDown=false, small=false) {
  const el = document.createElement('div');
  const cls = small ? 'card sm' : 'card';
  if (faceDown) { el.className = cls + ' back'; return el; }
  const red = REDS_S.has(card.s);
  el.className = cls + (red ? ' red-c' : '');
  el.innerHTML = `<div class="cn tl">${card.r}<br>${card.s}</div><div class="suit">${card.s}</div><div class="rank">${card.r}</div><div class="cn br">${card.r}<br>${card.s}</div>`;
  return el;
}

function renderDealerCards(hand, revealed) {
  const el = document.getElementById('dealerCards');
  const h = toArr(hand);
  const scoreEl = document.getElementById('dealerScore');

  if (!h || h.length === 0) {
    el.innerHTML = '<div style="width:48px;height:68px;border:2px dashed rgba(255,255,255,.1);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:20px;opacity:.2;">ğŸƒ</div>';
    el.dataset.dealerCount = '0';
    el.dataset.wasRevealed = 'false';
    scoreEl.textContent = '';
    return;
  }

  const currentCount = parseInt(el.dataset.dealerCount || '0');
  const wasRevealed = el.dataset.wasRevealed === 'true';

  if (currentCount === 0 || h.length < currentCount) {
    // Full re-render â€” staggered slide-in
    el.innerHTML = '';
    h.forEach((c, i) => {
      if (!c) return;
      const isHidden = !revealed && i === 1;
      const card = makeCardEl(c, isHidden, false);
      card.classList.add('deal-anim');
      card.style.animationDelay = (i * 0.2) + 's';
      el.appendChild(card);
      setTimeout(() => sfxCard(), i * 200);
    });
  } else if (!wasRevealed && revealed) {
    // Flip the hidden card (index 1) with slide animation
    const cards = el.querySelectorAll('.card');
    if (cards[1]) {
      const c = h[1];
      if (c) {
        const newCard = makeCardEl(c, false, false);
        newCard.classList.add('hit-anim');
        cards[1].replaceWith(newCard);
        sfxDealerFlip();
      }
    }
    // Add new cards dealer drew, one at a time
    for (let i = currentCount; i < h.length; i++) {
      if (h[i]) {
        setTimeout(() => {
          const newCard = makeCardEl(h[i], false, false);
          newCard.classList.add('hit-anim');
          el.appendChild(newCard);
          sfxCard();
          updateDealerScore(h, revealed);
        }, (i - currentCount + 1) * 600);
      }
    }
  } else if (h.length > currentCount) {
    // Add only new cards
    for (let i = currentCount; i < h.length; i++) {
      if (h[i]) {
        const newCard = makeCardEl(h[i], false, false);
        newCard.classList.add('hit-anim');
        el.appendChild(newCard);
        sfxCard();
      }
    }
  }

  el.dataset.dealerCount = String(h.length);
  el.dataset.wasRevealed = String(revealed);
  updateDealerScore(h, revealed);
}

function updateDealerScore(h, revealed) {
  const scoreEl = document.getElementById('dealerScore');
  if (!scoreEl) return;
  const arr = toArr(h);
  if (revealed) {
    const total = handTotal(arr);
    scoreEl.textContent = `Dealer: ${total}${total > 21 ? ' â€” BUST' : ''}`;
    scoreEl.style.color = total > 21 ? '#e74c3c' : total === 21 ? '#f0d060' : 'rgba(255,255,255,.7)';
  } else {
    scoreEl.textContent = `Dealer: ${arr[0] ? cardVal(arr[0]) : '?'} + ?`;
    scoreEl.style.color = 'rgba(255,255,255,.35)';
  }
}

function renderOpponents(room, currentTurn) {
  const zone = document.getElementById('opponentsZone');
  zone.innerHTML = '';
  const players = room.players || {};
  const order = room.turnOrder || Object.keys(players);

  order.filter(pid => pid !== myId).forEach(pid => {
    const p = players[pid];
    if (!p) return;
    const hand = toArr(p.hand);
    const total = hand.length > 0 ? handTotal(hand) : 0;
    const isTurn = pid === currentTurn;
    const status = p.status || '';

    const panel = document.createElement('div');
    panel.className = 'opponent-panel' + (isTurn ? ' active-turn' : '') +
      (status === 'bust' ? ' bust-p' : '') +
      (p.result === 'win' || p.result === 'blackjack' ? ' win-p' : '');

    if (isTurn) {
      const arrow = document.createElement('div');
      arrow.className = 'turn-arrow';
      arrow.textContent = 'ğŸ¯ TURNO';
      panel.appendChild(arrow);
    }

    const hdr = document.createElement('div'); hdr.className = 'op-header';
    hdr.appendChild(makeAvatar(p.name, p.color, 26));
    const nm = document.createElement('div'); nm.className = 'op-name'; nm.textContent = p.name;
    hdr.appendChild(nm); panel.appendChild(hdr);

    const cards = document.createElement('div'); cards.className = 'op-cards';
    if (hand.length === 0) {
      const ph = document.createElement('div');
      ph.style.cssText = 'width:38px;height:54px;border:1px dashed rgba(255,255,255,.1);border-radius:5px;opacity:.3;';
      cards.appendChild(ph);
    } else {
      hand.forEach(c => cards.appendChild(makeCardEl(c, false, true)));
    }
    panel.appendChild(cards);

    const foot = document.createElement('div'); foot.className = 'op-footer';

    // Result overlay on cards
    if (p.result) {
      const ro = document.createElement('div');
      const cls = p.result==='win'||p.result==='blackjack' ? 'cr-win' : p.result==='push' ? 'cr-push' : 'cr-lose';
      ro.className = 'card-result ' + cls;
      ro.style.cssText = 'position:absolute;top:42px;left:10px;right:10px;height:54px;';
      ro.textContent = p.result==='blackjack'?'BJ!':p.result==='win'?'WIN':p.result==='push'?'PUSH':'BUST';
      panel.style.position = 'relative';
      panel.appendChild(ro);
    }

    const scoreDiv = document.createElement('div');
    scoreDiv.className = 'op-score';
    scoreDiv.style.color = total > 21 ? '#e74c3c' : total === 21 ? '#f0d060' : '#fff';
    scoreDiv.textContent = hand.length > 0 ? total : 'â€”';

    const betDiv = document.createElement('div'); betDiv.className = 'op-bet';
    // Only show chip when bet is confirmed (not during betting phase)
    if (p.bet > 0 && status !== 'betting') {
      const chipEl = makeChipStack(p.bet, 'sm');
      betDiv.appendChild(chipEl);
    }

    const statusDiv = document.createElement('div');
    statusDiv.className = 'op-status ' + getStatusClass(status);
    statusDiv.textContent = getStatusText(status, p.result);

    foot.appendChild(scoreDiv); foot.appendChild(betDiv);
    panel.appendChild(foot); panel.appendChild(statusDiv);
    zone.appendChild(panel);
  });
}

function getStatusClass(s) {
  if (s === 'betting') return 'ops-betting';
  if (s === 'stand') return 'ops-stand';
  if (s === 'bust') return 'ops-bust';
  if (s === 'blackjack') return 'ops-bj';
  if (s === 'playing' || s === 'waiting_turn') return 'ops-playing';
  return 'ops-wait';
}
function getStatusText(s, result) {
  if (result === 'win') return 'âœ… WIN';
  if (result === 'blackjack') return 'ğŸƒ BJ';
  if (result === 'lose') return 'âŒ Pierde';
  if (result === 'push') return 'ğŸ¤ Push';
  if (s === 'betting' || s === 'bet_ready') return 'ğŸ’° Apostando';
  if (s === 'stand') return 'âœ‹ Plantado';
  if (s === 'bust') return 'ğŸ’¥ Bust';
  if (s === 'blackjack') return 'ğŸƒ BJ!';
  if (s === 'playing') return 'ğŸ¯ Jugando';
  if (s === 'waiting_turn') return 'â³ Espera';
  return 'â³ Espera';
}

function renderMyCards(hand) {
  const el = document.getElementById('myCards');
  const h = toArr(hand);
  if (!h || h.length === 0) {
    el.innerHTML = '<div style="color:var(--dim);font-size:12px;font-style:italic">Las cartas aparecerÃ¡n aquÃ­...</div>';
    el.dataset.cardCount = '0';
    return;
  }
  const currentCount = parseInt(el.dataset.cardCount || '0');

  if (currentCount === 0 || h.length < currentCount) {
    // Full re-render (initial deal) â€” staggered slide-in for each card
    el.innerHTML = '';
    h.forEach((c, i) => {
      if (!c) return;
      const card = makeCardEl(c, false, false);
      card.classList.add('deal-anim');
      card.style.animationDelay = (i * 0.18) + 's';
      el.appendChild(card);
      // Play sound staggered
      setTimeout(() => sfxCard(), i * 180);
    });
  } else if (h.length > currentCount) {
    // New hit cards â€” slide in from side
    for (let i = currentCount; i < h.length; i++) {
      if (h[i]) {
        const card = makeCardEl(h[i], false, false);
        card.classList.add('hit-anim');
        el.appendChild(card);
        sfxCard();
      }
    }
  }
  el.dataset.cardCount = String(h.length);
}

function clearMyCards() {
  const el = document.getElementById('myCards');
  el.innerHTML = '<div style="color:var(--dim);font-size:12px;font-style:italic">Las cartas aparecerÃ¡n aquÃ­...</div>';
  el.dataset.cardCount = '0';
  el.dataset.splitFp = '';
}

function updateMyLiveScore(hand, status) {
  const el = document.getElementById('myLiveScore');
  if (!hand || hand.length === 0) { el.style.display = 'none'; return; }
  el.style.display = 'inline-block';
  const t = handTotal(hand);
  el.textContent = t;
  el.className = 'my-live-score mls-up';
  void el.offsetWidth;
  if (t > 21) el.className = 'my-live-score mls-bust';
  else if (t === 21) el.className = 'my-live-score mls-bj';
  else if (t >= 17) el.className = 'my-live-score mls-warn';
  else el.className = 'my-live-score mls-safe';
}

function setStatusBadge(type, text) {
  const el = document.getElementById('statusBadge');
  el.className = 'game-status-badge gsb-' + type;
  el.textContent = text;
}

function setBannerMsg(msg, cls) {
  const el = document.getElementById('msgBanner');
  el.textContent = msg; el.className = 'msg-banner ' + cls;
}

function showWaitMsg(msg) {
  const el = document.getElementById('waitMsg');
  el.textContent = msg; el.style.display = 'block';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SOLO MODE VS DEALER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function playSolo() {
  soloMode = true;
  roomCode = 'SOLO';
  isHost = false;
  soloBet = 0; myBet = 0;

  // Show game screen
  hide('scLobby');
  const g = document.getElementById('scGame');
  g.classList.remove('hidden');
  g.style.display = 'flex';
  g.style.flexDirection = 'column';
  document.getElementById('gameCode').textContent = 'ğŸ¤– vs Dealer';
  document.getElementById('myName2').textContent = myName;
  document.getElementById('myBalance').textContent = '$' + myBal.toLocaleString();
  document.getElementById('opponentsZone').innerHTML = '';
  hideEl('hostGameCtrl'); hideEl('guestGameCtrl');
  showEl('soloExitBtn');
  hideEl('playActions'); hideEl('waitMsg');
  hideEl('resultsOverlay');
  document.getElementById('msgBanner').textContent = '';
  // Show stats bar in solo mode
  document.getElementById('statsBar').style.display = 'flex';
  renderStatsBar();
  clearMyCards();
  renderDealerCards([], false);
  document.getElementById('dealerScore').textContent = '';

  soloStartBetting();
}

function soloStartBetting() {
  soloPhase = 'betting';
  soloBet = 0; myBet = 0;
  setStatusBadge('betting', 'ğŸ’° Tu apuesta');
  document.getElementById('myBetDisplay').textContent = '0';
  showEl('betPanel');
  hideEl('playActions'); hideEl('waitMsg');
  hideEl('myLiveScore');
  document.getElementById('msgBanner').textContent = '';
  clearMyCards();
  renderDealerCards([], false);
  document.getElementById('dealerScore').textContent = '';
}

function soloConfirmBet() {
  if (myBet < 1) { toast('âš ï¸ Coloca al menos $1'); return; }
  if (myBal < myBet) { toast('âš ï¸ Saldo insuficiente'); return; }
  soloBet = myBet;
  hideEl('betPanel');
  // Show bet chip
  const myBetChip = document.getElementById('myBetChip');
  myBetChip.innerHTML = '';
  myBetChip.appendChild(makeChipStack(soloBet));
  myBetChip.style.display = '';
  soloDeal();
}

function soloDeal() {
  soloPhase = 'playing';
  soloDeck = buildShuffledDeck(4);
  let di = 0;
  const pop = () => soloDeck[di++];

  soloPlayerHand = [pop(), pop()];
  soloDealerHand = [pop(), pop()];
  soloSplitHand = null; soloSplitBet = 0; soloActiveSplit = 0;

  setStatusBadge('playing', 'ğŸƒ Tu turno');

  // Animate cards with stagger
  renderDealerCards(soloDealerHand, false);
  renderMyCards(soloPlayerHand);
  updateMyLiveScore(soloPlayerHand, 'playing');
  showEl('myLiveScore');
  document.getElementById('myBalance').textContent = '$' + myBal.toLocaleString();

  const total = handTotal(soloPlayerHand);
  if (total === 21) {
    // Blackjack!
    document.getElementById('myLiveScore').className = 'my-live-score mls-bj';
    setBannerMsg('ğŸƒ Â¡BLACKJACK!', 'mb-win');
    setTimeout(soloDealerPlay, 1200);
    return;
  }

  showEl('playActions', 'flex');
  document.getElementById('btnDouble').disabled = myBal < soloBet;
  // Show split button if same rank and enough balance
  const splitBtn = document.getElementById('btnSplit');
  const canSplit = soloPlayerHand[0]?.r === soloPlayerHand[1]?.r && myBal >= soloBet;
  splitBtn.style.display = canSplit ? '' : 'none';
  document.getElementById('msgBanner').textContent = '';
}

function soloHit() {
  if (soloPhase !== 'playing') return;
  // Use split-aware card offset, or standard calculation
  let nextCard;
  if (soloActiveSplit > 0) {
    nextCard = soloDeck[soloSplitCardOffset++];
  } else {
    nextCard = soloDeck[soloPlayerHand.length + soloDealerHand.length];
  }
  soloPlayerHand.push(nextCard);
  renderMyCards(soloPlayerHand);
  updateMyLiveScore(soloPlayerHand, 'playing');
  const total = handTotal(soloPlayerHand);
  if (total > 21) {
    setBannerMsg('ğŸ’¥ Â¡Te pasaste! (' + total + ')', 'mb-lose');
    hideEl('playActions');
    if (soloActiveSplit === 1 && soloSplitHand) {
      setTimeout(() => soloStartHand2(), 900);
    } else {
      setTimeout(soloDealerPlay, 800);
    }
  } else if (total === 21) {
    hideEl('playActions');
    if (soloActiveSplit === 1 && soloSplitHand) {
      setTimeout(() => soloStartHand2(), 700);
    } else {
      setTimeout(soloDealerPlay, 600);
    }
  } else {
    document.getElementById('btnDouble').disabled = true;
  }
}

function soloStand() {
  if (soloPhase !== 'playing') return;
  hideEl('playActions');
  if (soloActiveSplit === 1 && soloSplitHand) {
    setTimeout(() => soloStartHand2(), 500);
  } else {
    setTimeout(soloDealerPlay, 500);
  }
}

function soloDouble() {
  if (soloPhase !== 'playing' || myBal < soloBet) return;
  soloBet *= 2;
  myBet = soloBet;
  let nextCardD;
  if (soloActiveSplit > 0) {
    nextCardD = soloDeck[soloSplitCardOffset++];
  } else {
    nextCardD = soloDeck[soloPlayerHand.length + soloDealerHand.length];
  }
  soloPlayerHand.push(nextCardD);
  renderMyCards(soloPlayerHand);
  updateMyLiveScore(soloPlayerHand, 'playing');
  hideEl('playActions');
  const total = handTotal(soloPlayerHand);
  if (total > 21) setBannerMsg('ğŸ’¥ Â¡Te pasaste! (' + total + ')', 'mb-lose');
  // If split, go to hand2 after double
  if (soloActiveSplit === 1 && soloSplitHand) {
    setTimeout(() => soloStartHand2(), 800);
  } else {
    setTimeout(soloDealerPlay, 800);
  }
}

function soloSplit() {
  if (soloPhase !== 'playing') return;
  if (soloPlayerHand.length !== 2) return;
  if (soloPlayerHand[0].r !== soloPlayerHand[1].r) { toast('âš ï¸ Solo puedes dividir con dos cartas iguales'); return; }
  if (myBal < soloBet) { toast('âš ï¸ Saldo insuficiente para dividir'); return; }

  myBal -= soloBet;
  soloSplitBet = soloBet;
  soloActiveSplit = 1;

  // Use a simple sequential index from the deck for new cards
  // soloDeck was built with pop() so next cards are at increasing indices
  const usedCards = soloPlayerHand.length + soloDealerHand.length;
  const nextCard1 = soloDeck[usedCards];
  const nextCard2 = soloDeck[usedCards + 1];

  const hand1 = [soloPlayerHand[0], nextCard1];
  const hand2 = [soloPlayerHand[1], nextCard2];

  soloPlayerHand = hand1;
  soloSplitHand = hand2;
  soloSplitCardOffset = usedCards + 2; // next available card after split cards

  // Clear and render split view
  const el = document.getElementById('myCards');
  el.dataset.cardCount = '0';
  renderMyCards(soloPlayerHand);
  updateMyLiveScore(soloPlayerHand, 'playing');
  setBannerMsg('âœ‚ï¸ Mano 1 de 2 â€” juega', 'mb-push');
  document.getElementById('btnSplit').style.display = 'none';
  document.getElementById('btnDouble').disabled = true;
  document.getElementById('myBalance').textContent = '$' + myBal.toLocaleString();
  toast('âœ‚ï¸ Dividido â€” juega la mano 1', 2000);
}

function soloStartHand2() {
  soloActiveSplit = 2;
  soloPlayerHand = soloSplitHand;
  soloSplitHand = null;
  // soloSplitCardOffset is already set from when we split
  // Reset render state
  const el = document.getElementById('myCards');
  el.dataset.cardCount = '0';
  el.dataset.splitFp = '';
  renderMyCards(soloPlayerHand);
  updateMyLiveScore(soloPlayerHand, 'playing');
  setBannerMsg('âœ‚ï¸ Mano 2 de 2 â€” Â¡Juega!', 'mb-push');
  showEl('playActions', 'flex');
  document.getElementById('btnDouble').disabled = myBal < soloSplitBet;
  document.getElementById('btnSplit').style.display = 'none';
}

async function soloDealerPlay() {
  soloPhase = 'dealer';
  setStatusBadge('dealer', 'ğŸ¦ Dealer juega');
  hideEl('playActions');
  showWaitMsg('ğŸ¦ El dealer estÃ¡ jugando...');

  // Reveal hole card
  renderDealerCards(soloDealerHand, true);
  await new Promise(r => setTimeout(r, 700));

  // Dealer hits until 17 â€” use split-aware offset
  let idx = soloActiveSplit > 0 ? soloSplitCardOffset : (soloPlayerHand.length + soloDealerHand.length);
  while (handTotal(soloDealerHand) < 17) {
    soloDealerHand.push(soloDeck[idx++]);
    renderDealerCards(soloDealerHand, true);
    await new Promise(r => setTimeout(r, 700));
  }

  hideEl('waitMsg');
  soloShowResults();
}

function soloShowResults() {
  soloPhase = 'results';
  setStatusBadge('results', 'ğŸ† Resultado');

  const playerTotal = handTotal(soloPlayerHand);
  const dealerTotal = handTotal(soloDealerHand);
  const playerBJ = playerTotal === 21 && soloPlayerHand.length === 2;
  const dealerBJ = dealerTotal === 21 && soloDealerHand.length === 2;
  const bust = playerTotal > 21;

  let result, payout, bannerMsg, bannerCls;

  if (bust) {
    result = 'lose'; payout = 0;
    bannerMsg = 'âŒ Perdiste $' + soloBet; bannerCls = 'mb-lose';
  } else if (playerBJ && !dealerBJ) {
    result = 'blackjack'; payout = Math.floor(soloBet * 2.5);
    bannerMsg = 'ğŸƒ Â¡BLACKJACK! +$' + (payout - soloBet); bannerCls = 'mb-win';
    bigBurst();
  } else if (dealerBJ && !playerBJ) {
    result = 'lose'; payout = 0;
    bannerMsg = 'âŒ Dealer Blackjack. Perdiste $' + soloBet; bannerCls = 'mb-lose';
  } else if (dealerTotal > 21) {
    result = 'win'; payout = soloBet * 2;
    bannerMsg = 'ğŸ‰ Â¡Dealer bust! +$' + soloBet; bannerCls = 'mb-win';
    burst(window.innerWidth / 2, 200, 22);
  } else if (playerTotal > dealerTotal) {
    result = 'win'; payout = soloBet * 2;
    bannerMsg = 'ğŸ‰ Â¡Ganaste! +$' + soloBet; bannerCls = 'mb-win';
    burst(window.innerWidth / 2, 200, 22);
  } else if (playerTotal === dealerTotal) {
    result = 'push'; payout = soloBet;
    bannerMsg = 'ğŸ¤ Empate â€” apuesta devuelta'; bannerCls = 'mb-push';
  } else {
    result = 'lose'; payout = 0;
    bannerMsg = 'âŒ Perdiste $' + soloBet; bannerCls = 'mb-lose';
  }

  // Update balance
  myBal = myBal - soloBet + payout;
  if (myBal < 0) myBal = 0;

  // Update stats
  soloStats.handsPlayed++;
  soloStats.totalProfit += (payout - soloBet);
  if (result === 'win' || result === 'blackjack') {
    soloStats.wins++;
    soloStats.streak = Math.max(0, soloStats.streak) + 1;
    soloStats.bestStreak = Math.max(soloStats.bestStreak, soloStats.streak);
    if (result === 'blackjack') soloStats.blackjacks++;
    result === 'blackjack' ? sfxBlackjack() : sfxWin();
  } else if (result === 'push') {
    soloStats.pushes++;
    soloStats.streak = 0;
  } else {
    soloStats.losses++;
    soloStats.streak = Math.min(0, soloStats.streak) - 1;
    sfxLose();
  }
  saveStats();
  renderStatsBar();

  saveLocal();
  document.getElementById('myBalance').textContent = '$' + myBal.toLocaleString();
  setBannerMsg(bannerMsg, bannerCls);

  // Apply card glow
  setTimeout(() => {
    document.querySelectorAll('#myCards .card').forEach(c => {
      if (result === 'win') c.classList.add('win-glow');
      else if (result === 'blackjack') c.classList.add('bj-glow');
      else if (result === 'lose') c.classList.add('bust-glow');
    });
  }, 200);

  // Show results overlay
  const overlay = document.getElementById('resultsOverlay');
  const profit = payout - soloBet;
  overlay.style.cssText = 'display:flex;flex-direction:column;align-items:center;justify-content:flex-start;position:absolute;inset:0;background:rgba(0,0,0,.9);z-index:200;padding:20px 16px 28px;overflow-y:auto;animation:jpIn .3s ease;';

  const list = document.getElementById('resultsList');
  list.innerHTML = '';

  // Big result banner
  const bigResult = document.createElement('div');
  bigResult.style.cssText = 'text-align:center;margin:10px 0 14px;';
  let bigIcon, bigText, bigColor;
  if (result==='blackjack') { bigIcon='ğŸƒ'; bigText='BLACKJACK!'; bigColor='#f0d060'; }
  else if (result==='win')  { bigIcon='ğŸ‰'; bigText='Â¡GANASTE!'; bigColor='#2ecc71'; }
  else if (result==='push') { bigIcon='ğŸ¤'; bigText='EMPATE'; bigColor='#c9a84c'; }
  else                      { bigIcon='ğŸ’€'; bigText='PERDISTE'; bigColor='#e74c3c'; }
  bigResult.innerHTML = `
    <div style="font-size:44px;line-height:1;margin-bottom:4px">${bigIcon}</div>
    <div style="font-size:22px;font-weight:900;letter-spacing:4px;color:${bigColor};text-shadow:0 0 20px ${bigColor}55">${bigText}</div>
    <div style="font-size:15px;font-weight:bold;color:${profit>=0?'#2ecc71':'#e74c3c'};margin-top:6px">${profit>=0?'+':''}$${profit}</div>
  `;
  list.appendChild(bigResult);

  // Card comparison row
  const comparison = document.createElement('div');
  comparison.style.cssText = 'display:flex;gap:12px;justify-content:center;align-items:flex-start;margin-bottom:14px;width:100%;';
  comparison.innerHTML = `
    <div style="text-align:center;flex:1">
      <div style="font-size:9px;letter-spacing:2px;color:rgba(255,255,255,.35);margin-bottom:4px">TÃš</div>
      <div style="font-size:28px;font-weight:900;color:${playerTotal>21?'#e74c3c':playerTotal===21?'#f0d060':'#fff'}">${playerTotal}</div>
      <div style="font-size:10px;color:rgba(255,255,255,.3)">${playerTotal>21?'BUST':playerBJ?'BLACKJACK':''}</div>
    </div>
    <div style="color:rgba(255,255,255,.2);font-size:18px;padding-top:10px">vs</div>
    <div style="text-align:center;flex:1">
      <div style="font-size:9px;letter-spacing:2px;color:rgba(255,255,255,.35);margin-bottom:4px">DEALER</div>
      <div style="font-size:28px;font-weight:900;color:${dealerTotal>21?'#e74c3c':dealerTotal===21?'#f0d060':'#fff'}">${dealerTotal}</div>
      <div style="font-size:10px;color:rgba(255,255,255,.3)">${dealerTotal>21?'BUST':dealerBJ?'BLACKJACK':''}</div>
    </div>
  `;
  list.appendChild(comparison);

  // Mini stats row
  const wr = soloStats.handsPlayed > 0 ? Math.round(soloStats.wins * 100 / soloStats.handsPlayed) : 0;
  const miniStats = document.createElement('div');
  miniStats.style.cssText = 'display:flex;gap:6px;justify-content:center;width:100%;margin-bottom:14px;flex-wrap:wrap;';
  miniStats.innerHTML = `
    <div style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:6px 12px;text-align:center;">
      <div style="font-size:8px;color:rgba(255,255,255,.3);letter-spacing:1px">MANOS</div>
      <div style="font-size:14px;font-weight:bold">${soloStats.handsPlayed}</div>
    </div>
    <div style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:6px 12px;text-align:center;">
      <div style="font-size:8px;color:rgba(255,255,255,.3);letter-spacing:1px">WIN%</div>
      <div style="font-size:14px;font-weight:bold;color:${wr>=50?'#2ecc71':'#e74c3c'}">${wr}%</div>
    </div>
    <div style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:6px 12px;text-align:center;">
      <div style="font-size:8px;color:rgba(255,255,255,.3);letter-spacing:1px">RACHA</div>
      <div style="font-size:14px;font-weight:bold;color:${soloStats.streak>0?'#f39c12':'#e74c3c'}">${soloStats.streak>0?'ğŸ”¥':'â„ï¸'} ${soloStats.streak}</div>
    </div>
    <div style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:6px 12px;text-align:center;">
      <div style="font-size:8px;color:rgba(255,255,255,.3);letter-spacing:1px">SALDO</div>
      <div style="font-size:14px;font-weight:bold;color:#f0d060">$${myBal.toLocaleString()}</div>
    </div>
  `;
  list.appendChild(miniStats);

  document.getElementById('soloNextBtn').style.display = 'block';
  document.getElementById('hostNextBtn').style.display = 'none';
  document.getElementById('guestNextMsg').style.display = 'none';

  if (myBal <= 0) {
    myBal = INIT_BAL;
    saveLocal();
    document.getElementById('myBalance').textContent = '$' + myBal.toLocaleString();
    const bk = document.createElement('div');
    bk.style.cssText = 'background:rgba(231,76,60,.1);border:1px solid rgba(231,76,60,.3);border-radius:12px;padding:12px;text-align:center;margin-top:8px;';
    bk.innerHTML = '<div style="font-size:22px;margin-bottom:4px">ğŸ’¸</div><div style="font-size:13px;font-weight:bold;color:#e74c3c">Â¡Sin fondos!</div><div style="font-size:11px;color:rgba(255,255,255,.5);margin-top:4px">Recarga gratuita de $1,000 aplicada ğŸ</div>';
    list.appendChild(bk);
  }
}

function soloNextRound() {
  const overlay = document.getElementById('resultsOverlay');
  overlay.style.display = 'none';
  document.getElementById('msgBanner').textContent = '';
  hideEl('myLiveScore');
  document.getElementById('myBetChip').style.display = 'none';
  soloSplitHand = null; soloSplitBet = 0; soloActiveSplit = 0; soloSplitCardOffset = 0;
  clearMyCards();
  renderDealerCards([], false);
  document.getElementById('dealerScore').textContent = '';
  myBet = 0;
  soloStartBetting();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COPY ROOM CODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyRoomCode() {
  const code = document.getElementById('displayCode').textContent;
  if (!code || code === 'â€”â€”') return;
  const subEl = document.getElementById('codeCopySub');
  if (navigator.clipboard) {
    navigator.clipboard.writeText(code).then(() => {
      subEl.textContent = 'âœ… Â¡CÃ³digo copiado!';
      document.getElementById('displayCode').style.color = '#2ecc71';
      setTimeout(() => {
        subEl.textContent = 'ğŸ‘† Toca para copiar el cÃ³digo';
        document.getElementById('displayCode').style.color = '';
      }, 2000);
    });
  } else {
    // Fallback: select text
    const el = document.getElementById('displayCode');
    const range = document.createRange();
    range.selectNodeContents(el);
    window.getSelection().removeAllRanges();
    window.getSelection().addRange(range);
    document.execCommand('copy');
    subEl.textContent = 'âœ… Â¡CÃ³digo copiado!';
    setTimeout(() => { subEl.textContent = 'ğŸ‘† Toca para copiar el cÃ³digo'; }, 2000);
  }
  toast('ğŸ“‹ ' + code + ' copiado al portapapeles');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PWA SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pwaInstallPrompt = null;

function setupPWA() {
  // Generate SVG icon
  const iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" rx="80" fill="#0a6b2e"/><rect x="40" y="40" width="432" height="432" rx="60" fill="#084d20"/><text x="256" y="310" text-anchor="middle" font-size="260" font-family="serif">ğŸƒ</text><rect x="30" y="30" width="452" height="20" rx="10" fill="#5c2e08"/><rect x="30" y="462" width="452" height="20" rx="10" fill="#5c2e08"/></svg>`;
  const iconUrl = 'data:image/svg+xml,' + encodeURIComponent(iconSvg);

  // Set apple touch icon
  document.getElementById('appleIcon').href = iconUrl;

  // Create and set manifest
  const manifest = {
    name: 'BlackJack Royale',
    short_name: 'BlackJack',
    description: 'BlackJack multijugador en tiempo real',
    start_url: '.',
    display: 'standalone',
    orientation: 'portrait',
    background_color: '#042e10',
    theme_color: '#0a6b2e',
    icons: [
      { src: iconUrl, sizes: '512x512', type: 'image/svg+xml', purpose: 'any maskable' }
    ]
  };
  const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/manifest+json' });
  document.getElementById('pwaManifest').href = URL.createObjectURL(manifestBlob);

  // Register service worker (cache-first for offline play)
  if ('serviceWorker' in navigator) {
    const swCode = `
const CACHE = 'bj-royale-v1';
self.addEventListener('install', e => {
  e.waitUntil(caches.open(CACHE).then(c => c.add(new Request(self.location.href, {cache:'reload'}))));
  self.skipWaiting();
});
self.addEventListener('activate', e => {
  e.waitUntil(caches.keys().then(keys => Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))));
  self.clients.claim();
});
self.addEventListener('fetch', e => {
  e.respondWith(caches.match(e.request).then(r => r || fetch(e.request).catch(() => caches.match(e.request))));
});
`;
    const swBlob = new Blob([swCode], { type: 'application/javascript' });
    const swUrl = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl, { scope: './' }).catch(() => {});
  }

  // Listen for install prompt
  window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    pwaInstallPrompt = e;
    // Show banner after a delay
    setTimeout(() => {
      if (!window.matchMedia('(display-mode: standalone)').matches) {
        document.getElementById('pwaInstallBanner').style.display = 'block';
      }
    }, 4000);
  });

  // iOS: show banner if in Safari (no beforeinstallprompt)
  const isIos = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isInStandalone = window.navigator.standalone === true;
  if (isIos && !isInStandalone) {
    setTimeout(() => {
      const banner = document.getElementById('pwaInstallBanner');
      banner.style.display = 'block';
      banner.querySelector('.btn-gold').textContent = 'Â¿CÃ³mo?';
      banner.querySelector('.btn-gold').onclick = () => {
        alert('En Safari: toca el Ã­cono de compartir â†‘ â†’ "Agregar a pantalla de inicio"');
      };
    }, 5000);
  }
}

function installPWA() {
  if (pwaInstallPrompt) {
    pwaInstallPrompt.prompt();
    pwaInstallPrompt.userChoice.then(() => {
      pwaInstallPrompt = null;
      document.getElementById('pwaInstallBanner').style.display = 'none';
    });
  }
}
// Firebase ya estÃ¡ disponible porque sus <script> estÃ¡n en el <head> (sÃ­ncronos)
document.addEventListener('DOMContentLoaded', function() {
  setupPWA();
  initFirebase(FIREBASE_CFG);
  loadLocal();
  loadStats();
  if (myName) document.getElementById('nameInput').value = myName;
  document.getElementById('nameInput').addEventListener('keydown', e => { if (e.key === 'Enter') goLobby(); });
  document.getElementById('codeInput').addEventListener('keydown', e => { if (e.key === 'Enter') joinRoom(); });
  document.getElementById('codeInput').addEventListener('input', e => { e.target.value = e.target.value.toUpperCase(); });
});
// Setup host watcher when game starts
const _origListen = listenRoom;
</script>
</body>
</html>
